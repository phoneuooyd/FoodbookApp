<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:Foodbook.Models"
             xmlns:vm="clr-namespace:Foodbook.ViewModels"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             x:Class="Foodbook.Views.PlannerPage"
             x:Name="ThisPage"
             x:DataType="vm:PlannerViewModel"
             Title="Planer">
    
    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="*">
        
        <!-- Enhanced Loading Screen -->
        <StackLayout Grid.Row="0" 
                     IsVisible="{Binding IsLoading}" 
                     VerticalOptions="Center"
                     HorizontalOptions="Center"
                     Spacing="20"
                     Padding="40">
            
            <!-- Loading Animation -->
            <ActivityIndicator IsRunning="{Binding IsLoading}"
                              Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                              WidthRequest="60"
                              HeightRequest="60" />
            
            <!-- Loading Status Text -->
            <Label Text="{Binding LoadingStatus}" 
                   FontSize="16"
                   FontAttributes="Bold"
                   HorizontalTextAlignment="Center"
                   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
            
            <!-- Progress Bar -->
            <ProgressBar Progress="{Binding LoadingProgress}"
                         ProgressColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                         BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                         HeightRequest="6"
                         WidthRequest="300"
                         HorizontalOptions="Center" />
            
            <!-- Progress Percentage -->
            <Label FontSize="14"
                   HorizontalTextAlignment="Center"
                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}">
                <Label.Text>
                    <MultiBinding StringFormat="{}{0:P0}">
                        <Binding Path="LoadingProgress" />
                    </MultiBinding>
                </Label.Text>
            </Label>
            
            <!-- Helpful tip while loading -->
            <Label Text="ðŸ’¡ Przygotowywanie planera moÅ¼e potrwaÄ‡ chwilÄ™..." 
                   FontSize="12"
                   HorizontalTextAlignment="Center"
                   TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                   Margin="0,10,0,0" />
        </StackLayout>

        <!-- Main content -->
        <ScrollView Grid.Row="0" 
                    IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}">
            <VerticalStackLayout Padding="10" Spacing="15">
                
                <!-- Sekcja dat - rozÅ‚oÅ¼ona na peÅ‚nÄ… szerokoÅ›Ä‡ -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="15" Margin="0,5">
                    <!-- Data Od - maksymalnie po lewej -->
                    <VerticalStackLayout Grid.Column="0" HorizontalOptions="Start">
                        <Label Text="Data od:" 
                               FontSize="12" 
                               FontAttributes="Bold" 
                               TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" 
                               Margin="0,0,0,5" />
                        <DatePicker Date="{Binding StartDate}" 
                                    Format="dd.MM.yyyy"
                                    FontSize="14"
                                    HorizontalOptions="FillAndExpand" />
                    </VerticalStackLayout>
                    
                    <!-- Data Do - maksymalnie po prawej -->
                    <VerticalStackLayout Grid.Column="1" HorizontalOptions="End">
                        <Label Text="Data do:" 
                               FontSize="12" 
                               FontAttributes="Bold" 
                               TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" 
                               Margin="0,0,0,5" />
                        <DatePicker Date="{Binding EndDate}" 
                                    Format="dd.MM.yyyy"
                                    FontSize="14"
                                    HorizontalOptions="FillAndExpand" />
                    </VerticalStackLayout>
                </Grid>
                
                <!-- Sekcja iloÅ›ci posiÅ‚kÃ³w - wyÅ›rodkowana, niÅ¼ej -->
                <HorizontalStackLayout HorizontalOptions="Center" Spacing="10">
                    <Label Text="PosiÅ‚kÃ³w dziennie:" 
                           VerticalOptions="Center" 
                           FontSize="14" 
                           FontAttributes="Bold" 
                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                    <Entry Text="{Binding MealsPerDay}" 
                           Keyboard="Numeric" 
                           WidthRequest="50" 
                           FontSize="14"
                           HorizontalTextAlignment="Center" />
                </HorizontalStackLayout>
                
                <!-- Lista dni z posiÅ‚kami -->
                <VerticalStackLayout BindableLayout.ItemsSource="{Binding Days}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="models:PlannerDay">
                            <Frame BorderColor="LightGray" Padding="8" Margin="0,3">
                                <VerticalStackLayout>
                                    <!-- Data dnia w polskim formacie -->
                                    <Label Text="{Binding Date, StringFormat='{0:dd.MM.yyyy}'}" 
                                           FontAttributes="Bold" 
                                           FontSize="14" />
                                           
                                    <StackLayout BindableLayout.ItemsSource="{Binding Meals}">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:PlannedMeal">
                                                <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto" ColumnSpacing="4" Margin="0,1">
                                                    <!-- Picker z elastycznÄ… szerokoÅ›ciÄ… -->
                                                    <Picker Grid.Column="0" 
                                                            ItemsSource="{Binding Source={x:Reference ThisPage}, Path=BindingContext.Recipes}" 
                                                            ItemDisplayBinding="{Binding Name}" 
                                                            SelectedItem="{Binding Recipe}"
                                                            FontSize="12" />
                                                    
                                                    <!-- Przycisk zmniejszenia porcji -->
                                                    <Button Grid.Column="1" 
                                                            Text="âž–"
                                                            Command="{Binding BindingContext.DecreasePortionsCommand, Source={x:Reference ThisPage}}"
                                                            CommandParameter="{Binding .}"
                                                            WidthRequest="30" 
                                                            HeightRequest="30"
                                                            CornerRadius="15"
                                                            FontSize="16"
                                                            FontAttributes="Bold"
                                                            BorderWidth="0"
                                                            Padding="0">
                                                        <Button.Triggers>
                                                            <DataTrigger TargetType="Button" Binding="{Binding Portions}" Value="1">
                                                                <Setter Property="IsEnabled" Value="False" />
                                                                <Setter Property="BackgroundColor" Value="LightGray" />
                                                            </DataTrigger>
                                                        </Button.Triggers>
                                                    </Button>
                                                    
                                                    <!-- Label z liczbÄ… porcji -->
                                                    <Label Grid.Column="2" 
                                                           Text="{Binding Portions}" 
                                                           VerticalOptions="Center" 
                                                           HorizontalOptions="Center"
                                                           FontSize="14" 
                                                           FontAttributes="Bold"
                                                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                                           WidthRequest="24"
                                                           HorizontalTextAlignment="Center" />
                                                    
                                                    <!-- Przycisk zwiÄ™ksenia porcji -->
                                                    <Button Grid.Column="3" 
                                                            Text="âž•"
                                                            Command="{Binding BindingContext.IncreasePortionsCommand, Source={x:Reference ThisPage}}"
                                                            CommandParameter="{Binding .}"
                                                            WidthRequest="30" 
                                                            HeightRequest="30"
                                                            CornerRadius="15"
                                                            FontSize="16"
                                                            FontAttributes="Bold"
                                                            BorderWidth="0"
                                                            Padding="0">
                                                        <Button.Triggers>
                                                            <DataTrigger TargetType="Button" Binding="{Binding Portions}" Value="20">
                                                                <Setter Property="IsEnabled" Value="False" />
                                                                <Setter Property="BackgroundColor" Value="LightGray" />
                                                            </DataTrigger>
                                                        </Button.Triggers>
                                                    </Button>
                                                    
                                                    <!-- Przycisk usuwania posiÅ‚ku -->
                                                    <Button Grid.Column="4" 
                                                            Text="âŒ" 
                                                            Command="{Binding BindingContext.RemoveMealCommand, Source={x:Reference ThisPage}}" 
                                                            CommandParameter="{Binding .}" 
                                                            WidthRequest="26" 
                                                            HeightRequest="26"
                                                            CornerRadius="13"
                                                            BackgroundColor="Transparent"
                                                            TextColor="Red"
                                                            FontSize="12"
                                                            FontAttributes="Bold"
                                                            BorderWidth="0"
                                                            Padding="0" />
                                                </Grid>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </StackLayout>
                                    
                                    <!-- WyÅ›rodkowany przycisk "Dodaj posiÅ‚ek" -->
                                    <StackLayout HorizontalOptions="Center" Margin="0,8,0,0">
                                        <Button Text="âž• Dodaj posiÅ‚ek" 
                                                Command="{Binding BindingContext.AddMealCommand, Source={x:Reference ThisPage}}" 
                                                CommandParameter="{Binding .}"
                                                FontSize="12"
                                                FontAttributes="Bold"
                                                CornerRadius="6"
                                                Padding="12,6"
                                                WidthRequest="120"
                                                HeightRequest="32" />
                                    </StackLayout>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>
                
                <!-- Przycisk Zapisz - wyÅ›rodkowany -->
                <HorizontalStackLayout Spacing="10" Margin="0,20,0,0" HorizontalOptions="Center">
                    <Button Text="ðŸ’¾ Zapisz" Command="{Binding SaveCommand}" />
                </HorizontalStackLayout>
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
