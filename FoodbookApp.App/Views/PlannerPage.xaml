<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:loc="clr-namespace:Foodbook.Services"
             xmlns:models="clr-namespace:Foodbook.Models"
             xmlns:vm="clr-namespace:Foodbook.ViewModels"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             xmlns:components="clr-namespace:Foodbook.Views.Components"
             xmlns:resources="clr-namespace:FoodbookApp.Localization"
             x:Class="Foodbook.Views.PlannerPage"
             x:Name="ThisPage"
             x:DataType="vm:PlannerViewModel"
             Title="{loc:Translate Resource=PlannerPageResources, Key=Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">
    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
    </ContentPage.Resources>
    <Grid RowDefinitions="*">
        <!-- Loading -->
        <StackLayout Grid.Row="0" IsVisible="{Binding IsLoading}" VerticalOptions="Center" HorizontalOptions="Center" Spacing="20" Padding="40">
            <ActivityIndicator IsRunning="{Binding IsLoading}" Color="{DynamicResource Primary}" WidthRequest="60" HeightRequest="60" />
            <Label Text="{Binding LoadingStatus}" FontSize="16" FontAttributes="Bold" HorizontalTextAlignment="Center" TextColor="{DynamicResource Primary}" />
            <ProgressBar Progress="{Binding LoadingProgress}" ProgressColor="{DynamicResource Primary}" BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}" HeightRequest="6" WidthRequest="300" HorizontalOptions="Center" />
            <Label FontSize="14" HorizontalTextAlignment="Center" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}">
                <Label.Text>
                    <MultiBinding StringFormat="{}{0:P0}">
                        <Binding Path="LoadingProgress" />
                    </MultiBinding>
                </Label.Text>
            </Label>
            <Label FontSize="12" HorizontalTextAlignment="Center" TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}" Margin="0,10,0,0" Text="{loc:Translate Resource=PlannerPageResources, Key=LoadingTip}" />
        </StackLayout>
        <!-- Content -->
        <ScrollView Grid.Row="0" IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}">
            <VerticalStackLayout Padding="10" Spacing="15">
                <Grid ColumnDefinitions="*,*" ColumnSpacing="15" Margin="0,5">
                    <VerticalStackLayout Grid.Column="0" HorizontalOptions="Start">
                        <Label Text="{loc:Translate Resource=PlannerPageResources, Key=DateFrom}" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Primary}" Margin="0,0,0,5" />
                        <DatePicker Date="{Binding StartDate}" Format="dd.MM.yyyy" FontSize="14" HorizontalOptions="FillAndExpand" />
                    </VerticalStackLayout>
                    <VerticalStackLayout Grid.Column="1" HorizontalOptions="End">
                        <Label Text="{loc:Translate Resource=PlannerPageResources, Key=DateTo}" FontSize="12" FontAttributes="Bold" TextColor="{DynamicResource Primary}" Margin="0,0,0,5" />
                        <DatePicker Date="{Binding EndDate}" Format="dd.MM.yyyy" FontSize="14" HorizontalOptions="FillAndExpand" />
                    </VerticalStackLayout>
                </Grid>
                <HorizontalStackLayout HorizontalOptions="Center" Spacing="10">
                    <Label Text="{loc:Translate Resource=PlannerPageResources, Key=MealsPerDay}" VerticalOptions="Center" FontSize="14" FontAttributes="Bold" TextColor="{DynamicResource Primary}" />
                    <Entry Text="{Binding MealsPerDay}" Keyboard="Numeric" WidthRequest="50" FontSize="14" HorizontalTextAlignment="Center" />
                </HorizontalStackLayout>
                <VerticalStackLayout BindableLayout.ItemsSource="{Binding Days}">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="models:PlannerDay">
                            <Frame BorderColor="LightGray" Padding="8" Margin="0,3">
                                <VerticalStackLayout>
                                    <Label Text="{Binding Date, StringFormat='{0:dd.MM.yyyy}'}" FontAttributes="Bold" FontSize="14" />
                                    <StackLayout BindableLayout.ItemsSource="{Binding Meals}">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:PlannedMeal">
                                                <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto" ColumnSpacing="4" Margin="0,1">
                                                    <!-- Replace standard Picker with FolderAwarePicker -->
                                                    <components:FolderAwarePickerComponent Grid.Column="0" 
                                                                                          SelectedRecipe="{Binding Recipe}" 
                                                                                          PlaceholderText="{loc:Translate Resource=PlannerPageResources, Key=SelectRecipePlaceholder}" />
                                                    <Button Grid.Column="1" Text="➖" Command="{Binding BindingContext.DecreasePortionsCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" WidthRequest="30" HeightRequest="30" CornerRadius="15" FontSize="16" FontAttributes="Bold" BorderWidth="0" Padding="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}" TextColor="{AppThemeBinding Light=Black, Dark=White}">
                                                        <Button.Triggers>
                                                            <DataTrigger TargetType="Button" Binding="{Binding Portions}" Value="1">
                                                                <Setter Property="IsEnabled" Value="False" />
                                                                <Setter Property="BackgroundColor" Value="LightGray" />
                                                            </DataTrigger>
                                                        </Button.Triggers>
                                                    </Button>
                                                    <Label Grid.Column="2" Text="{Binding Portions}" VerticalOptions="Center" HorizontalOptions="Center" FontSize="14" FontAttributes="Bold" TextColor="{DynamicResource Primary}" WidthRequest="24" HorizontalTextAlignment="Center" />
                                                    <Button Grid.Column="3" Text="➕" Command="{Binding BindingContext.IncreasePortionsCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" WidthRequest="30" HeightRequest="30" CornerRadius="15" FontSize="16" FontAttributes="Bold" BorderWidth="0" Padding="0" BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource PrimaryDark}}" TextColor="{AppThemeBinding Light=Black, Dark=White}">
                                                        <Button.Triggers>
                                                            <DataTrigger TargetType="Button" Binding="{Binding Portions}" Value="20">
                                                                <Setter Property="IsEnabled" Value="False" />
                                                                <Setter Property="BackgroundColor" Value="LightGray" />
                                                            </DataTrigger>
                                                        </Button.Triggers>
                                                    </Button>
                                                    <Button Grid.Column="4" Text="✕" Command="{Binding BindingContext.RemoveMealCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" WidthRequest="35" HeightRequest="35" BackgroundColor="{AppThemeBinding Light=#FFE6E6, Dark=#4A2C2C}" TextColor="{AppThemeBinding Light=#CC0000, Dark=#FF6666}" FontSize="16" CornerRadius="17" BorderColor="{AppThemeBinding Light=#FFCCCC, Dark=#664444}" BorderWidth="1" Padding="0" />
                                                </Grid>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </StackLayout>
                                    <StackLayout HorizontalOptions="Center" Margin="0,8,0,0">
                                        <Button Command="{Binding BindingContext.AddMealCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" FontSize="12" FontAttributes="Bold" CornerRadius="6" Padding="12,6" WidthRequest="120" HeightRequest="32" BackgroundColor="{DynamicResource Primary}" Text="{loc:Translate Resource=PlannerPageResources, Key=AddMeal}" />
                                    </StackLayout>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </VerticalStackLayout>
                <HorizontalStackLayout Spacing="10" Margin="0,20,0,0" HorizontalOptions="Center">
                    <Button Command="{Binding SaveCommand}" BackgroundColor="{DynamicResource Primary}">
                        <Button.ImageSource>
                            <FileImageSource File="save.png" />
                        </Button.ImageSource>
                    </Button>
                </HorizontalStackLayout>
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
