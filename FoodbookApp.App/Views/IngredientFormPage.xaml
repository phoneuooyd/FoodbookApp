<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:loc="clr-namespace:Foodbook.Services"
             xmlns:vm="clr-namespace:Foodbook.ViewModels"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             xmlns:resources="clr-namespace:FoodbookApp.Localization"
             xmlns:controls="clr-namespace:Foodbook.Views.Components"
             x:Class="Foodbook.Views.IngredientFormPage"
             x:Name="ThisPage"
             x:DataType="vm:IngredientFormViewModel"
             Title="{Binding Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">
    <ContentPage.Resources>
        <converters:StringToBoolConverter x:Key="StringToBoolConverter" />
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        <!-- Localized unit converter to show unit names from resx and respect language changes -->
        <converters:UnitToLocalizedStringConverter x:Key="UnitToStringConverter" />
    </ContentPage.Resources>
    
    <Grid RowDefinitions="*,Auto">
        <controls:TabComponent Grid.Row="0" SelectedIndex="{Binding SelectedTabIndex}" SelectTabCommand="{Binding SelectTabCommand}">
            <controls:TabComponent.Tabs>
                <!-- Basic Info Tab -->
                <controls:TabItem Name="{loc:Translate Resource=IngredientFormPageResources, Key=BasicInfoTab}">
                    <controls:TabItem.Content>
                        <ScrollView>
                            <VerticalStackLayout Padding="20" Spacing="15">
                                <Label Text="{Binding Title}" FontSize="24" FontAttributes="Bold" HorizontalOptions="Center" Margin="0,0,0,10" />
                                <Label Text="{loc:Translate Resource=IngredientFormPageResources, Key=BasicInfoHeader}" FontSize="18" FontAttributes="Bold" Margin="0,10,0,5" />
                                <Border Style="{StaticResource ModernBorder}">
                                    <StackLayout Spacing="5" Padding="12,8">
                                        <Label Text="{loc:Translate Resource=IngredientFormPageResources, Key=NameLabel}" Style="{StaticResource FieldLabel}" />
                                        <Entry Placeholder="{loc:Translate Resource=IngredientFormPageResources, Key=NamePlaceholder}" Text="{Binding Name}" ClearButtonVisibility="WhileEditing" Style="{StaticResource ModernEntry}" />
                                    </StackLayout>
                                </Border>
                                <Grid ColumnDefinitions="2*,*" ColumnSpacing="10">
                                    <Border Grid.Column="0" Style="{StaticResource ModernBorder}">
                                        <StackLayout Spacing="5" Padding="12,8">
                                            <Label Text="{loc:Translate Resource=IngredientFormPageResources, Key=QuantityLabel}" Style="{StaticResource FieldLabel}" />
                                            <Entry Placeholder="100" Keyboard="Numeric" Text="{Binding Quantity}" ClearButtonVisibility="WhileEditing" HorizontalTextAlignment="Center" Style="{StaticResource ModernEntry}" />
                                        </StackLayout>
                                    </Border>
                                    <Border Grid.Column="1" Style="{StaticResource ModernBorder}">
                                        <StackLayout Spacing="5" Padding="12,8">
                                            <Label Text="{loc:Translate Resource=IngredientFormPageResources, Key=UnitLabel}" Style="{StaticResource FieldLabel}" />
                                            <controls:SimplePicker ItemsSource="{Binding Units}"
                                                                   SelectedItem="{Binding SelectedUnit}"
                                                                   ItemDisplayBinding="{Binding Converter={StaticResource UnitToStringConverter}}" />
                                        </StackLayout>
                                    </Border>
                                </Grid>
                                <!-- UnitWeight field, visible only for Piece -->
                                <Border Style="{StaticResource ModernBorder}" IsVisible="{Binding IsUnitWeightVisible}">
                                    <StackLayout Spacing="5" Padding="12,8">
                                        <Label Text="Waga 1 sztuki [g]" Style="{StaticResource FieldLabel}" />
                                        <Entry Placeholder="np. 60" Keyboard="Numeric" Text="{Binding UnitWeight}" ClearButtonVisibility="WhileEditing" HorizontalTextAlignment="Center" Style="{StaticResource ModernEntry}" />
                                    </StackLayout>
                                </Border>
                                <StackLayout Spacing="5" IsVisible="{Binding IsPartOfRecipe}" Margin="0,15,0,0">
                                    <Label Text="{loc:Translate Resource=IngredientFormPageResources, Key=InfoLabel}" FontSize="14" FontAttributes="Bold" />
                                    <Border BackgroundColor="{AppThemeBinding Light=#E6F4FF, Dark=#203040}" StrokeThickness="0" StrokeShape="RoundRectangle 6">
                                        <Label Padding="10" Text="{Binding RecipeInfo}" FontSize="12" HorizontalTextAlignment="Center" />
                                    </Border>
                                </StackLayout>
                            </VerticalStackLayout>
                        </ScrollView>
                    </controls:TabItem.Content>
                </controls:TabItem>
                
                <!-- Nutrition Tab -->
                <controls:TabItem Name="{loc:Translate Resource=IngredientFormPageResources, Key=NutritionTab}">
                    <controls:TabItem.Content>
                        <ScrollView>
                            <VerticalStackLayout Padding="20" Spacing="15">
                                <Label Text="{loc:Translate Resource=IngredientFormPageResources, Key=NutritionHeader}" FontSize="18" FontAttributes="Bold" Margin="0,10,0,5" />
                                <StackLayout Spacing="8">
                                    <Label Text="{loc:Translate Resource=IngredientFormPageResources, Key=VerifyLabel}" FontSize="14" FontAttributes="Bold" Margin="0,0,0,8" />
                                    <Button Text="{loc:Translate Resource=IngredientFormPageResources, Key=VerifyButton}"
                                            Command="{Binding VerifyNutritionCommand}"
                                            StyleClass="Secondary"
                                            FontSize="14" FontAttributes="Bold" HeightRequest="45" CornerRadius="8" Margin="0,0,0,8"
                                            HorizontalOptions="FillAndExpand" IsEnabled="{Binding IsVerifying, Converter={StaticResource InvertedBoolConverter}}" />
                                    <Label Text="{Binding VerificationStatus}" FontSize="12" HorizontalTextAlignment="Center" TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" IsVisible="{Binding VerificationStatus, Converter={StaticResource StringToBoolConverter}}" Margin="0,0,0,8" />
                                </StackLayout>
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="10" RowDefinitions="Auto,Auto" RowSpacing="10">
                                    <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource ModernBorder}">
                                        <StackLayout Spacing="5" Padding="12,8">
                                            <Label Text="{loc:Translate Resource=IngredientFormPageResources, Key=CaloriesLabel}" Style="{StaticResource FieldLabel}" />
                                            <Entry Placeholder="0.0" Keyboard="Numeric" Text="{Binding Calories}" ClearButtonVisibility="WhileEditing" HorizontalTextAlignment="Center" Style="{StaticResource ModernEntry}" />
                                        </StackLayout>
                                    </Border>
                                    <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource ModernBorder}">
                                        <StackLayout Spacing="5" Padding="12,8">
                                            <Label Text="{loc:Translate Resource=IngredientFormPageResources, Key=ProteinLabel}" Style="{StaticResource FieldLabel}" />
                                            <Entry Placeholder="0.0" Keyboard="Numeric" Text="{Binding Protein}" ClearButtonVisibility="WhileEditing" HorizontalTextAlignment="Center" Style="{StaticResource ModernEntry}" />
                                        </StackLayout>
                                    </Border>
                                    <Border Grid.Row="1" Grid.Column="0" Style="{StaticResource ModernBorder}">
                                        <StackLayout Spacing="5" Padding="12,8">
                                            <Label Text="{loc:Translate Resource=IngredientFormPageResources, Key=FatLabel}" Style="{StaticResource FieldLabel}" />
                                            <Entry Placeholder="0.0" Keyboard="Numeric" Text="{Binding Fat}" ClearButtonVisibility="WhileEditing" HorizontalTextAlignment="Center" Style="{StaticResource ModernEntry}" />
                                        </StackLayout>
                                    </Border>
                                    <Border Grid.Row="1" Grid.Column="1" Style="{StaticResource ModernBorder}">
                                        <StackLayout Spacing="5" Padding="12,8">
                                            <Label Text="{loc:Translate Resource=IngredientFormPageResources, Key=CarbsLabel}" Style="{StaticResource FieldLabel}" />
                                            <Entry Placeholder="0.0" Keyboard="Numeric" Text="{Binding Carbs}" ClearButtonVisibility="WhileEditing" HorizontalTextAlignment="Center" Style="{StaticResource ModernEntry}" />
                                        </StackLayout>
                                    </Border>
                                </Grid>
                            </VerticalStackLayout>
                        </ScrollView>
                    </controls:TabItem.Content>
                </controls:TabItem>
            </controls:TabComponent.Tabs>
        </controls:TabComponent>
        
        <!-- Save button - always visible at the bottom -->
        <VerticalStackLayout Grid.Row="1" Padding="20,10" Spacing="10" BackgroundColor="{DynamicResource PageBackgroundColor}">
            <Button Command="{Binding SaveCommand}" 
                    StyleClass="Primary"
                    HeightRequest="50" 
                    HorizontalOptions="FillAndExpand">
                <Button.ImageSource>
                    <FileImageSource File="save.png" />
                </Button.ImageSource>
            </Button>
            <Label Text="{Binding ValidationMessage}" 
                   FontSize="12" 
                   IsVisible="{Binding HasValidationError}" 
                   HorizontalTextAlignment="Center" 
                   TextColor="Red" />
        </VerticalStackLayout>
    </Grid>
</ContentPage>
