<?xml version="1.0" encoding="utf-8" ?>
<mct:Popup xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
           xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
           xmlns:mct="clr-namespace:CommunityToolkit.Maui.Views;assembly=CommunityToolkit.Maui"
           xmlns:converters="clr-namespace:Foodbook.Converters"
           xmlns:loc="clr-namespace:Foodbook.Services"
           xmlns:components="clr-namespace:Foodbook.Views.Components"
           xmlns:behaviors="clr-namespace:CommunityToolkit.Maui.Behaviors;assembly=CommunityToolkit.Maui"
           x:Class="Foodbook.Views.Components.FolderAwarePickerPopup"
           x:Name="ThisPopup"
           CanBeDismissedByTappingOutsideOfPopup="True"
           Padding="0"
	   Margin="0">

    <mct:Popup.Resources>
        <ResourceDictionary>
            <converters:ItemTypeToColorConverter x:Key="ItemTypeToColorConverter" />
            <converters:ItemTypeIsRecipeConverter x:Key="ItemTypeIsRecipeConverter" />
            <!-- Local overrides: make ModernSearchBar slightly smaller only in this popup -->
            <Style x:Key="ModernSearchBarFrame" TargetType="Frame">
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#F5F5F5, Dark=#3A3A3A}" />
                <Setter Property="BorderColor" Value="{AppThemeBinding Light=#E0E0E0, Dark=#555555}" />
                <Setter Property="CornerRadius" Value="22" />
                <Setter Property="Padding" Value="0" />
                <Setter Property="HeightRequest" Value="44" />
                <Setter Property="HasShadow" Value="False" />
            </Style>
            <Style x:Key="SearchIconLabel" TargetType="Label">
                <Setter Property="Text" Value="ðŸ”" />
                <Setter Property="FontSize" Value="16" />
                <Setter Property="HorizontalOptions" Value="Center" />
                <Setter Property="VerticalOptions" Value="Center" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light=#999999, Dark=#CCCCCC}" />
            </Style>
            <Style x:Key="ClearSearchButton" TargetType="Button">
                <Setter Property="Text" Value="X" />
                <Setter Property="FontSize" Value="12" />
                <Setter Property="WidthRequest" Value="26" />
                <Setter Property="HeightRequest" Value="26" />
                <Setter Property="CornerRadius" Value="13" />
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="TextColor" Value="{AppThemeBinding Light=#999999, Dark=#CCCCCC}" />
                <Setter Property="Padding" Value="0" />
                <Setter Property="BorderWidth" Value="0" />
            </Style>
        </ResourceDictionary>
    </mct:Popup.Resources>

    <Border BackgroundColor="{DynamicResource PopupBackgroundColor}"
            StrokeShape="RoundRectangle 12"
            StrokeThickness="1"
            Stroke="{DynamicResource Secondary}"
            MinimumWidthRequest="320"
            MaximumWidthRequest="560"
	    MinimumHeightRequest="360"
            MaximumHeightRequest="630">
        
        <Grid RowDefinitions="Auto,Auto,*">
            
            <!-- Header with search, filter and close -->
	    <StackLayout Grid.Row="0"
                        BackgroundColor="{DynamicResource ShellBackgroundColor}"
                        Padding="12,8"
				Margin="0,0">

                <Grid ColumnDefinitions="*,Auto,Auto" Padding="6,6">
                    <!-- Search bar full width -->
                    <StackLayout Grid.Column="0" Orientation="Vertical" Spacing="6">
                        <components:ModernSearchBarComponent
                            SearchText="{Binding SearchText, Source={x:Reference ThisPopup}}"
                            ClearCommand="{Binding ClearSearchCommand, Source={x:Reference ThisPopup}}">
                            <components:ModernSearchBarComponent.PlaceholderText>
                                <loc:Translate Resource="FolderResources" Key="SearchPlaceholder" />
                            </components:ModernSearchBarComponent.PlaceholderText>
                        </components:ModernSearchBarComponent>
			    </StackLayout>

                    <!-- Filter button -->
                    <ImageButton Grid.Column="1"
                                 Source="Resources/Images/filter.png"
                                 WidthRequest="32"
                                 HeightRequest="32"
                                 BackgroundColor="Transparent"
                                 Clicked="OnFilterSortClicked"
                                 HorizontalOptions="End"
                                 VerticalOptions="Center" />

                    <!-- Close button -->
		    <Button Grid.Column="2"
                            Text="X"
                            FontSize="16"
                            WidthRequest="32"
                            HeightRequest="32"
                            CornerRadius="16"
                            BackgroundColor="Transparent"
                            TextColor="{DynamicResource ShellTitleColor}"
                            Command="{Binding CloseCommand, Source={x:Reference ThisPopup}}" />
			</Grid>
		</StackLayout>

            <!-- Back row under header -->
            <Grid Grid.Row="1"
                  BackgroundColor="{DynamicResource ShellBackgroundColor}"
                  Padding="12,0,12,6"
                  IsVisible="{Binding HasBreadcrumb, Source={x:Reference ThisPopup}}">
                <Button Text="â†"
                        FontSize="16"
                        WidthRequest="32"
                        HeightRequest="32"
                        CornerRadius="16"
                        BackgroundColor="Transparent"
                        TextColor="{DynamicResource ShellTitleColor}"
                        HorizontalOptions="Start"
                        Command="{Binding BackCommand, Source={x:Reference ThisPopup}}" />
            </Grid>
            
            <!-- Content -->
            <ScrollView Grid.Row="2" 
                        BackgroundColor="{DynamicResource PopupBackgroundColor}"
                        Padding="6,4">
                <StackLayout BindableLayout.ItemsSource="{Binding Items, Source={x:Reference ThisPopup}}"
                             Spacing="8">
                    
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <ContentView>
                                <Border Padding="16,14"
                                        Margin="2,4"
                                        StrokeThickness="1"
                                        StrokeShape="RoundRectangle 8"
                                        x:Name="ItemBorder"
                                        BindingContext="{Binding .}">
                                    
                                    <!-- Default shadow (subtle) -->
                                    <Border.Shadow>
                                        <Shadow Brush="{AppThemeBinding Light=#40000000, Dark=#60000000}"
                                                Offset="0,1"
                                                Radius="2"
                                                Opacity="0.3" />
                                    </Border.Shadow>
                                    
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Style.Triggers>
                                                <DataTrigger TargetType="Border" 
                                                           Binding="{Binding ItemType}" 
                                                           Value="Folder">
                                                    <Setter Property="BackgroundColor" Value="{DynamicResource FolderCardBackgroundColor}" />
                                                    <Setter Property="Stroke" Value="{DynamicResource FolderCardStrokeColor}" />
                                                </DataTrigger>
                                                <DataTrigger TargetType="Border" 
                                                           Binding="{Binding ItemType}" 
                                                           Value="Recipe">
                                                    <Setter Property="BackgroundColor" Value="{DynamicResource PopupBackgroundColor}" />
                                                    <Setter Property="Stroke" Value="{DynamicResource Secondary}" />
                                                </DataTrigger>
                                                <DataTrigger TargetType="Border" 
                                                           Binding="{Binding ItemType}" 
                                                           Value="Navigation">
                                                    <Setter Property="BackgroundColor" Value="{DynamicResource FolderCardBackgroundColor}" />
                                                    <Setter Property="Stroke" Value="{DynamicResource FolderCardStrokeColor}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    
                                    <!-- TouchBehavior handles BOTH tap and long press with visual feedback -->
                                    <Border.Behaviors>
                                        <behaviors:TouchBehavior
                                            LongPressDuration="600"
                                            LongPressCommand="{Binding LongPressCommand, Source={x:Reference ThisPopup}}"
                                            LongPressCommandParameter="{Binding Source={x:Reference ItemBorder}, Path=BindingContext}"
                                            Command="{Binding TapCommand, Source={x:Reference ThisPopup}}"
                                            CommandParameter="{Binding Source={x:Reference ItemBorder}, Path=BindingContext}"
                                            DefaultAnimationDuration="150"
                                            DefaultAnimationEasing="{x:Static Easing.CubicInOut}"
                                            PressedOpacity="0.75"
                                            PressedScale="0.97"
                                            HoveredOpacity="0.9"
                                            HoveredScale="1.02"
                                            ShouldMakeChildrenInputTransparent="True" />
                                    </Border.Behaviors>
                                    
                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                        <!-- Icon -->
                                        <Label Grid.Column="0"
                                               Text="{Binding Icon}"
                                               FontSize="18"
                                               VerticalOptions="Center"
                                               Margin="0,0,12,0"
                                               IsVisible="{Binding HasIcon}"
                                               TextColor="{DynamicResource PrimaryText}" />
                                        
                                        <!-- Content -->
                                        <StackLayout Grid.Column="1" 
                                                   VerticalOptions="Center"
                                                   Spacing="3">
                                            <Label Text="{Binding DisplayName}"
                                                   FontSize="17"
                                                   FontAttributes="{Binding FontAttributes}"
                                                   TextColor="{DynamicResource PrimaryText}"
                                                   LineBreakMode="TailTruncation" />
                                            
                                            <Label Text="{Binding Description}"
                                                   FontSize="13"
                                                   TextColor="{DynamicResource SecondaryText}"
                                                   IsVisible="{Binding HasDescription}"
                                                   LineBreakMode="TailTruncation" />
                                        </StackLayout>
                                        
                                        <!-- Arrow for folders -->
                                        <Label Grid.Column="2"
                                               Text="&#8250;"
                                               FontSize="20"
                                               VerticalOptions="Center"
                                               TextColor="{DynamicResource SecondaryText}"
                                               IsVisible="{Binding ShowArrow}" />
                                    </Grid>
                                </Border>
                            </ContentView>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                    
                    <BindableLayout.EmptyView>
                        <StackLayout Padding="0" 
                                   Spacing="16"
                                   VerticalOptions="CenterAndExpand"
                                   HorizontalOptions="CenterAndExpand">
                            <Label Text="ðŸ“"
                                   FontSize="48"
                                   HorizontalOptions="Center"
                                   TextColor="{DynamicResource SecondaryText}" />
                            <Label FontSize="16" HorizontalOptions="Center" TextColor="{DynamicResource PrimaryText}" HorizontalTextAlignment="Center">
                                <Label.Text>
                                    <loc:Translate Resource="FolderResources" Key="EmptyFolderTitle" />
                                </Label.Text>
                            </Label>
                            <Label FontSize="14" HorizontalOptions="Center" TextColor="{DynamicResource SecondaryText}" HorizontalTextAlignment="Center">
                                <Label.Text>
                                    <loc:Translate Resource="FolderResources" Key="EmptyFolderHint" />
                                </Label.Text>
                            </Label>
                        </StackLayout>
                    </BindableLayout.EmptyView>
                </StackLayout>
            </ScrollView>
            
            <!-- Footer removed -->
        </Grid>
    </Border>
</mct:Popup>