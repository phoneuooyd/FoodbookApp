<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             x:Class="Foodbook.Views.Components.UniversalListItemComponent"
             x:Name="ItemComponent">

    <!-- Wrapper grid adds top/bottom drop zones for precise reordering -->
    <Grid RowDefinitions="Auto,Auto,Auto">
        <!-- Top insert zone (shows a separator and triggers Before drop) -->
        <BoxView x:Name="TopInsertZone"
                 Grid.Row="0"
                 HeightRequest="6"
                 BackgroundColor="{DynamicResource Primary}"
                 Opacity="0"
                 IsVisible="{Binding ShowDragAndDrop, Source={x:Reference ItemComponent}}">
            <BoxView.Triggers>
                <DataTrigger TargetType="BoxView" Binding="{Binding ., Converter={StaticResource IsFolderConverter}}" Value="False">
                    <Setter Property="IsVisible" Value="False" />
                </DataTrigger>
            </BoxView.Triggers>
            <BoxView.GestureRecognizers>
                <DropGestureRecognizer AllowDrop="True"
                                        DragOver="OnTopInsertDragOver"
                                        DragLeave="OnTopInsertDragLeave"
                                        Drop="OnTopInsertDrop" />
            </BoxView.GestureRecognizers>
        </BoxView>

        <ContentView Grid.Row="1" Style="{StaticResource ListItemContainer}">
            <!-- Frame as the outer card; ribbon moved INSIDE and flush with the card's left edge -->
            <Frame Style="{StaticResource ListItemFrame}" Padding="0">
                <Frame.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding EditCommand, Source={x:Reference ItemComponent}}"
                                          CommandParameter="{Binding .}" />
                    <!-- Drag & Drop support -->
                    <DragGestureRecognizer DragStarting="OnDragStarting" CanDrag="True" />
                    <DropGestureRecognizer AllowDrop="True" DragOver="OnDragOver" DragLeave="OnDragLeave" Drop="OnDrop" />
                </Frame.GestureRecognizers>

                <!-- Layout: narrow left ribbon column + content -->
                <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto">
                    <!-- Ribbon shown only for folders; collapses when not a folder -->
                    <BoxView Grid.Column="0"
                             WidthRequest="6"
                             BackgroundColor="{DynamicResource Primary}"
                             IsVisible="{Binding ., Converter={StaticResource IsFolderConverter}}">
                        <BoxView.Triggers>
                            <DataTrigger TargetType="BoxView" Binding="{Binding ., Converter={StaticResource IsFolderConverter}}" Value="False">
                                <Setter Property="WidthRequest" Value="0" />
                            </DataTrigger>
                        </BoxView.Triggers>
                    </BoxView>

                    <!-- Content area (keeps inner spacing) -->
                    <Grid Grid.Column="1" Margin="12" Style="{StaticResource ListItemContentGrid}" ColumnDefinitions="*,Auto,Auto,Auto">
                        <StackLayout Grid.Column="0" Spacing="2">
                            <!-- Title for Recipe/Ingredient, Label for Plan -->
                            <Label x:Name="TitleLabel" Text="{Binding Name}" Style="{StaticResource ItemTitleLabel}">
                                <Label.Triggers>
                                    <!-- Plan: show Label instead of Name -->
                                    <DataTrigger TargetType="Label" Binding="{Binding ., Converter={StaticResource IsPlanConverter}}" Value="True">
                                        <Setter Property="Text" Value="{Binding Label}" />
                                    </DataTrigger>
                                    <!-- Folder: increase font size and use themed text color -->
                                    <DataTrigger TargetType="Label" Binding="{Binding ., Converter={StaticResource IsFolderConverter}}" Value="True">
                                        <Setter Property="FontSize" Value="22" />
                                        <Setter Property="TextColor" Value="{DynamicResource FolderCardTextColor}" />
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>

                            <!-- Subtitle for ingredients (quantity + unit) -->
                            <Label Style="{StaticResource SubtitleLabel}"
                                   IsVisible="{Binding ShowSubtitle, Source={x:Reference ItemComponent}}">
                                <Label.Text>
                                    <MultiBinding StringFormat="{}{0} {1}">
                                        <Binding Path="Quantity" />
                                        <Binding Path="Unit" Converter="{StaticResource UnitToLocalizedStringConverter}" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>

                            <!-- Plan dates layout - single line -->
                            <Label Style="{StaticResource PlanDateLabel}"
                                   IsVisible="{Binding ShowPlanLayout, Source={x:Reference ItemComponent}}">
                                <Label.Text>
                                    <MultiBinding StringFormat="{}{0:dd.MM.yyyy} â€“ {1:dd.MM.yyyy}">
                                        <Binding Path="StartDate" />
                                        <Binding Path="EndDate" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>

                            <!-- Macros for recipes/ingredients (hidden for folders and when ShowNutritionLayout is false) -->
                            <StackLayout Style="{StaticResource NutritionContainer}"
                                         IsVisible="{Binding ShowNutritionLayout, Source={x:Reference ItemComponent}}">
                                <StackLayout.Triggers>
                                    <!-- Hide nutrition information for folders regardless of ShowNutritionLayout -->
                                    <DataTrigger TargetType="StackLayout" Binding="{Binding ., Converter={StaticResource IsFolderConverter}}" Value="True">
                                        <Setter Property="IsVisible" Value="False" />
                                    </DataTrigger>
                                </StackLayout.Triggers>
                                <Label Style="{StaticResource CaloriesLabel}">
                                    <Label.Text>
                                        <MultiBinding StringFormat="{}{0:F0} kcal">
                                            <Binding Path="Calories" />
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                                <Label Style="{StaticResource MacroLabel}">
                                    <Label.Text>
                                        <MultiBinding StringFormat="P: {0:F1}g">
                                            <Binding Path="Protein" />
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                                <Label Style="{StaticResource MacroLabel}">
                                    <Label.Text>
                                        <MultiBinding StringFormat="F: {0:F1}g">
                                            <Binding Path="Fat" />
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                                <Label Style="{StaticResource MacroLabel}">
                                    <Label.Text>
                                        <MultiBinding StringFormat="C: {0:F1}g">
                                            <Binding Path="Carbs" />
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                            </StackLayout>
                        </StackLayout>

                        <!-- Archive button for plans -->
                        <ImageButton Grid.Column="1"
                                     Source="save.png"
                                     WidthRequest="36"
                                     HeightRequest="36"
                                     CornerRadius="18"
                                     BackgroundColor="{AppThemeBinding Light=#E6F0FF, Dark=#2A3A4A}"
                                     Padding="6"
                                     Command="{Binding ArchiveCommand, Source={x:Reference ItemComponent}}"
                                     CommandParameter="{Binding .}"
                                     IsVisible="{Binding ShowArchiveButton, Source={x:Reference ItemComponent}}" />

                        <!-- Restore button with redo icon -->
                        <Button Grid.Column="2"
                                Style="{StaticResource RestoreButton}"
                                Text=""
                                ImageSource="redo.png"
                                Command="{Binding RestoreCommand, Source={x:Reference ItemComponent}}"
                                CommandParameter="{Binding .}"
                                IsVisible="{Binding ShowRestoreButton, Source={x:Reference ItemComponent}}" />

                        <!-- Delete button -->
                        <Button Grid.Column="3"
                                Style="{StaticResource DeleteButton}"
                                Command="{Binding DeleteCommand, Source={x:Reference ItemComponent}}"
                                CommandParameter="{Binding .}"
                                IsVisible="{Binding ShowDeleteButton, Source={x:Reference ItemComponent}}" />
                    </Grid>
                </Grid>

                <Frame.Triggers>
                    <!-- Folder: increase overall height by +10px (66 -> 76) and apply themed background + stroke from ThemeService policy -->
                    <DataTrigger TargetType="Frame" Binding="{Binding ., Converter={StaticResource IsFolderConverter}}" Value="True">
                        <Setter Property="MinimumHeightRequest" Value="76" />
                        <Setter Property="HeightRequest" Value="76" />
                        <Setter Property="BackgroundColor" Value="{DynamicResource FolderCardBackgroundColor}" />
                        <Setter Property="BorderColor" Value="{DynamicResource FolderCardStrokeColor}" />
                    </DataTrigger>
                </Frame.Triggers>
            </Frame>
        </ContentView>

        <!-- Bottom insert zone (After) -->
        <BoxView x:Name="BottomInsertZone"
                 Grid.Row="2"
                 HeightRequest="6"
                 BackgroundColor="{DynamicResource Primary}"
                 Opacity="0"
                 IsVisible="{Binding ShowDragAndDrop, Source={x:Reference ItemComponent}}">
            <BoxView.Triggers>
                <DataTrigger TargetType="BoxView" Binding="{Binding ., Converter={StaticResource IsFolderConverter}}" Value="False">
                    <Setter Property="IsVisible" Value="False" />
                </DataTrigger>
            </BoxView.Triggers>
            <BoxView.GestureRecognizers>
                <DropGestureRecognizer AllowDrop="True"
                                        DragOver="OnBottomInsertDragOver"
                                        DragLeave="OnBottomInsertDragLeave"
                                        Drop="OnBottomInsertDrop" />
            </BoxView.GestureRecognizers>
        </BoxView>
    </Grid>

</ContentView>