<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             x:Class="Foodbook.Views.Components.UniversalListItemComponent"
             x:Name="ItemComponent">

    <ContentView.GestureRecognizers>
        <TapGestureRecognizer Command="{Binding EditCommand, Source={x:Reference ItemComponent}}"
                              CommandParameter="{Binding .}" />
    </ContentView.GestureRecognizers>

    <ContentView Style="{StaticResource ListItemContainer}">
        <!-- Frame as the outer card; ribbon moved INSIDE and flush with the card's left edge -->
        <Frame Style="{StaticResource ListItemFrame}" Padding="0">
            <Frame.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding EditCommand, Source={x:Reference ItemComponent}}"
                                      CommandParameter="{Binding .}" />
                <!-- Drag & Drop support -->
                <DragGestureRecognizer DragStarting="OnDragStarting" CanDrag="True" />
                <DropGestureRecognizer AllowDrop="True" DragOver="OnDragOver" DragLeave="OnDragLeave" Drop="OnDrop" />
            </Frame.GestureRecognizers>

            <!-- Layout: narrow left ribbon column + content -->
            <Grid ColumnDefinitions="Auto,*">
                <!-- Ribbon shown only for folders; collapses when not a folder -->
                <BoxView Grid.Column="0"
                         WidthRequest="6"
                         BackgroundColor="{DynamicResource Primary}"
                         IsVisible="{Binding ., Converter={converters:IsFolderConverter}}">
                    <BoxView.Triggers>
                        <DataTrigger TargetType="BoxView" Binding="{Binding ., Converter={converters:IsFolderConverter}}" Value="False">
                            <Setter Property="WidthRequest" Value="0" />
                        </DataTrigger>
                    </BoxView.Triggers>
                </BoxView>

                <!-- Content area (keeps inner spacing) -->
                <Grid Grid.Column="1" Margin="12" Style="{StaticResource ListItemContentGrid}" ColumnDefinitions="*,Auto,Auto">
                    <StackLayout Grid.Column="0" Spacing="2">
                        <Label x:Name="TitleLabel" Text="{Binding Name}" Style="{StaticResource ItemTitleLabel}">
                            <Label.Triggers>
                                <!-- Folder: increase font size by +4pt (18 -> 22) -->
                                <DataTrigger TargetType="Label" Binding="{Binding ., Converter={converters:IsFolderConverter}}" Value="True">
                                    <Setter Property="FontSize" Value="22" />
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>

                        <!-- Macros only for recipes -->
                        <StackLayout Style="{StaticResource NutritionContainer}"
                                     IsVisible="{Binding ., Converter={converters:IsRecipeConverter}}">
                            <Label Style="{StaticResource CaloriesLabel}">
                                <Label.Text>
                                    <MultiBinding StringFormat="{}{0:F0} kcal">
                                        <Binding Path="Calories" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>
                            <Label Style="{StaticResource MacroLabel}">
                                <Label.Text>
                                    <MultiBinding StringFormat="P: {0:F1}g">
                                        <Binding Path="Protein" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>
                            <Label Style="{StaticResource MacroLabel}">
                                <Label.Text>
                                    <MultiBinding StringFormat="F: {0:F1}g">
                                        <Binding Path="Fat" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>
                            <Label Style="{StaticResource MacroLabel}">
                                <Label.Text>
                                    <MultiBinding StringFormat="C: {0:F1}g">
                                        <Binding Path="Carbs" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>
                        </StackLayout>
                    </StackLayout>

                    <!-- Folder edit button -->
                    <Button Grid.Column="1"
                            Text="âœŽ"
                            FontSize="16"
                            WidthRequest="36"
                            HeightRequest="36"
                            CornerRadius="18"
                            BackgroundColor="{AppThemeBinding Light=#E6F0FF, Dark=#2A3A4A}"
                            TextColor="{AppThemeBinding Light=#004A99, Dark=#66B2FF}"
                            Command="{Binding FolderEditCommand, Source={x:Reference ItemComponent}}"
                            CommandParameter="{Binding .}"
                            IsVisible="{Binding ., Converter={converters:IsFolderConverter}}" />

                    <Button Grid.Column="2"
                            Style="{StaticResource DeleteButton}"
                            Command="{Binding DeleteCommand, Source={x:Reference ItemComponent}}"
                            CommandParameter="{Binding .}"
                            IsVisible="{Binding ShowDeleteButton, Source={x:Reference ItemComponent}}" />
                </Grid>
            </Grid>

            <Frame.Triggers>
                <!-- Folder: increase overall height by +10px (66 -> 76) -->
                <DataTrigger TargetType="Frame" Binding="{Binding ., Converter={converters:IsFolderConverter}}" Value="True">
                    <Setter Property="MinimumHeightRequest" Value="76" />
                    <Setter Property="HeightRequest" Value="76" />
                </DataTrigger>
            </Frame.Triggers>
        </Frame>
    </ContentView>

</ContentView>