<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:loc="clr-namespace:Foodbook.Services"
             xmlns:models="clr-namespace:Foodbook.Models"
             xmlns:vm="clr-namespace:Foodbook.ViewModels"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             xmlns:components="clr-namespace:Foodbook.Views.Components"
             x:Class="Foodbook.Views.ShoppingListDetailPage"
             x:Name="ThisPage"
             x:DataType="vm:ShoppingListDetailViewModel"
             Title="{loc:Translate Resource=ShoppingListDetailPageResources, Key=Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">
    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        
        <!-- Item template for shopping list items using ShoppingListItemComponent -->
        <DataTemplate x:Key="ShoppingItemTemplate" x:DataType="models:Ingredient">
            <components:ShoppingListItemComponent 
                RemoveItemCommand="{Binding BindingContext.RemoveItemCommand, Source={x:Reference ThisPage}}"
                ChangeUnitCommand="{Binding BindingContext.ChangeUnitCommand, Source={x:Reference ThisPage}}"
                UnitsSource="{Binding BindingContext.Units, Source={x:Reference ThisPage}}"
                ShowDragAndDrop="True"
                DragStartingCommand="{Binding BindingContext.ItemDraggedCommand, Source={x:Reference ThisPage}}"
                DragOverCommand="{Binding BindingContext.ItemDraggedOverCommand, Source={x:Reference ThisPage}}"
                DragLeaveCommand="{Binding BindingContext.ItemDragLeaveCommand, Source={x:Reference ThisPage}}"
                DropCommand="{Binding BindingContext.ItemDroppedCommand, Source={x:Reference ThisPage}}"
                ItemDroppedBeforeCommand="{Binding BindingContext.ItemDroppedBeforeCommand, Source={x:Reference ThisPage}}"
                ItemDroppedAfterCommand="{Binding BindingContext.ItemDroppedAfterCommand, Source={x:Reference ThisPage}}"
                EntryFocused="OnEntryFocused"
                EntryUnfocused="OnEntryUnfocused"
                UnitSelectionChanged="OnUnitPickerSelectionChanged" />
        </DataTemplate>
        
        <!-- Group header template -->
        <DataTemplate x:Key="ShoppingGroupHeaderTemplate" x:DataType="vm:ShoppingItemGroup">
            <StackLayout Padding="10,14,10,4">
                <!-- Separator line above "Collected" section -->
                <BoxView HeightRequest="1" 
                         BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" 
                         Margin="0,0,0,10"
                         IsVisible="{Binding IsCheckedGroup}" />
                
                <Label FontSize="18" 
                       FontAttributes="Bold" 
                       TextColor="{Binding GroupHeaderColor}" 
                       Text="{Binding GroupName}" />
            </StackLayout>
        </DataTemplate>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*" Padding="0">
        <!-- Header -->
        <Grid Row="0" Padding="10" ColumnDefinitions="*,Auto,Auto" BackgroundColor="Transparent">
            <Label Grid.Column="0" 
                   FontSize="18" 
                   FontAttributes="Bold" 
                   TextColor="{DynamicResource Primary}" 
                   VerticalOptions="Center" 
                   Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=ToBuy}" />
            
            <Button Grid.Column="1" 
                    x:Name="SaveButton" 
                    Command="{Binding SaveAllCommand}" 
                    WidthRequest="44" 
                    HeightRequest="44" 
                    CornerRadius="22" 
                    Padding="0" 
                    Margin="8,0,0,0" 
                    VerticalOptions="Center" 
                    HorizontalOptions="End" 
                    StyleClass="Secondary" 
                    VisualElement.ZIndex="10">
                <Button.ImageSource>
                    <FileImageSource File="save.png" />
                </Button.ImageSource>
                <Button.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding HasUnsavedChanges}" Value="True">
                        <Setter Property="BackgroundColor" Value="{DynamicResource Primary}" />
                        <Setter Property="Opacity" Value="1" />
                    </DataTrigger>
                    <DataTrigger TargetType="Button" Binding="{Binding HasUnsavedChanges}" Value="False">
                        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#E0E0E0, Dark=#303030}" />
                        <Setter Property="Opacity" Value="0.55" />
                    </DataTrigger>
                </Button.Triggers>
            </Button>
            
            <Button Grid.Column="2" 
                    Command="{Binding AddItemCommand}" 
                    WidthRequest="44" 
                    HeightRequest="44" 
                    CornerRadius="22" 
                    Padding="0" 
                    Margin="8,0,0,0" 
                    Text="+" 
                    VerticalOptions="Center" 
                    HorizontalOptions="End" 
                    StyleClass="Secondary" 
                    VisualElement.ZIndex="10" />
        </Grid>

        <!-- Use CollectionView directly - it has native scrolling + grouping support -->
        <CollectionView Grid.Row="1"
            x:Name="ShoppingCollectionView"
            ItemsSource="{Binding AllItemsGrouped}"
            ItemTemplate="{StaticResource ShoppingItemTemplate}"
            IsGrouped="True"
            SelectionMode="None"
            ItemSizingStrategy="MeasureAllItems">
            
            <CollectionView.GroupHeaderTemplate>
                <DataTemplate x:DataType="vm:ShoppingItemGroup">
                    <StackLayout Padding="10,14,10,4">
                        <!-- Separator line above "Collected" section -->
                        <BoxView HeightRequest="1" 
                                 BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" 
                                 Margin="0,0,0,10"
                                 IsVisible="{Binding IsCheckedGroup}" />
                        
                        <Label FontSize="18" 
                               FontAttributes="Bold" 
                               TextColor="{Binding GroupHeaderColor}" 
                               Text="{Binding GroupName}" />
                    </StackLayout>
                </DataTemplate>
            </CollectionView.GroupHeaderTemplate>
            
            <CollectionView.Footer>
                <StackLayout Padding="10,10,10,20">
                    <Label Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=NoCollected}" 
                           TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}" 
                           HorizontalTextAlignment="Center" 
                           IsVisible="{Binding HasCheckedItems, Converter={StaticResource InvertedBoolConverter}, Source={x:Reference ThisPage}}" />
                </StackLayout>
            </CollectionView.Footer>
        </CollectionView>
    </Grid>
</ContentPage>
