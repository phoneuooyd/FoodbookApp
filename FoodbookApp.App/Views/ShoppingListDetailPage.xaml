<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:loc="clr-namespace:Foodbook.Services"
             xmlns:models="clr-namespace:Foodbook.Models"
             xmlns:vm="clr-namespace:Foodbook.ViewModels"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             xmlns:resources="clr-namespace:FoodbookApp.Localization"
             x:Class="Foodbook.Views.ShoppingListDetailPage"
             x:Name="ThisPage"
             x:DataType="vm:ShoppingListDetailViewModel"
             Title="{loc:Translate Resource=ShoppingListDetailPageResources, Key=Title}">
    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <converters:DragToColorConverter x:Key="DragToColorConverter" />
        
        <!-- Template for reorderable items -->
        <DataTemplate x:Key="ReorderableItemTemplate" x:DataType="models:Ingredient">
            <Border x:Name="ItemContainer"
                    Stroke="LightGray" 
                    Padding="5" 
                    Margin="0,2"
                    BackgroundColor="{Binding IsBeingDragged, Converter={StaticResource DragToColorConverter}}"
                    StrokeThickness="1">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                
                <VerticalStackLayout>
                    <Grid ColumnDefinitions="Auto,Auto,2*,Auto,Auto,Auto" ColumnSpacing="5"
                          BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                          Padding="5">
                        
                        <!-- Drag handle -->
                        <ContentView Grid.Column="0" 
                                   VerticalOptions="Center">
                            <Border BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                    WidthRequest="35" 
                                    HeightRequest="35"
                                    StrokeThickness="1"
                                    Stroke="{AppThemeBinding Light=#C0C0C0, Dark=#606060}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="6" />
                                </Border.StrokeShape>
                                <Grid>
                                    <Path Data="M8,4 L8,6 L10,6 L10,4 Z M8,8 L8,10 L10,10 L10,8 Z M8,12 L8,14 L10,14 L10,12 Z M12,4 L12,6 L14,6 L14,4 Z M12,8 L12,10 L14,10 L14,8 Z M12,12 L12,14 L14,14 L14,12 Z"
                                          Fill="{AppThemeBinding Light=#808080, Dark=#C0C0C0}"
                                          HorizontalOptions="Center" 
                                          VerticalOptions="Center"
                                          WidthRequest="18"
                                          HeightRequest="18" />
                                </Grid>
                            </Border>
                        </ContentView>

                        <CheckBox Grid.Column="1" 
                                IsChecked="{Binding IsChecked}" 
                                VerticalOptions="Center" />

                        <!-- Nazwa składnika -->
                        <Entry Grid.Column="2" 
                               Text="{Binding Name}" 
                               Placeholder="Nazwa"
                               VerticalOptions="Center" />

                        <!-- Ilość -->
                        <Entry Grid.Column="3" 
                               Text="{Binding Quantity}" 
                               Keyboard="Numeric" 
                               WidthRequest="60"
                               HorizontalTextAlignment="Center"
                               VerticalOptions="Center" />

                        <!-- Jednostka -->
                        <Picker Grid.Column="4" 
                                WidthRequest="80" 
                                ItemsSource="{Binding BindingContext.Units, Source={x:Reference ThisPage}}" 
                                SelectedItem="{Binding Unit}"
                                VerticalOptions="Center" />

                        <!-- Przycisk usuwania -->
                        <Button Grid.Column="5" 
                                Text="✕" 
                                Command="{Binding BindingContext.RemoveItemCommand, Source={x:Reference ThisPage}}" 
                                CommandParameter="{Binding .}" 
                                WidthRequest="35" 
                                HeightRequest="35"
                                BackgroundColor="{AppThemeBinding Light=#FFE6E6, Dark=#4A2C2C}"
                                TextColor="{AppThemeBinding Light=#CC0000, Dark=#FF6666}"
                                FontSize="16"
                                CornerRadius="17"
                                BorderColor="{AppThemeBinding Light=#FFCCCC, Dark=#664444}"
                                BorderWidth="1"
                                VerticalOptions="Center" />
                        
                        <Grid.GestureRecognizers>
                            <DragGestureRecognizer CanDrag="True" 
                                                 DragStartingCommand="{Binding BindingContext.ItemDraggedCommand, Source={x:Reference ThisPage}}"
                                                 DragStartingCommandParameter="{Binding .}" />
                            <DropGestureRecognizer AllowDrop="True" 
                                                 DragLeaveCommand="{Binding BindingContext.ItemDragLeaveCommand, Source={x:Reference ThisPage}}"
                                                 DragLeaveCommandParameter="{Binding .}"
                                                 DragOverCommand="{Binding BindingContext.ItemDraggedOverCommand, Source={x:Reference ThisPage}}"
                                                 DragOverCommandParameter="{Binding .}"
                                                 DropCommand="{Binding BindingContext.ItemDroppedCommand, Source={x:Reference ThisPage}}"
                                                 DropCommandParameter="{Binding .}" />
                        </Grid.GestureRecognizers>
                    </Grid>
                    
                    <!-- Drag over indicator -->
                    <StackLayout BackgroundColor="LightGray"
                               HeightRequest="30"
                               HorizontalOptions="FillAndExpand"
                               IsVisible="{Binding IsBeingDraggedOver}"
                               VerticalOptions="FillAndExpand" />
                </VerticalStackLayout>
            </Border>
        </DataTemplate>
        
        <!-- Template for checked (collected) items -->
        <DataTemplate x:Key="CheckedItemTemplate" x:DataType="models:Ingredient">
            <Border x:Name="ItemContainer"
                    Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" 
                    Padding="5" 
                    Margin="0,2"
                    BackgroundColor="{Binding IsBeingDragged, Converter={StaticResource DragToColorConverter}}"
                    StrokeThickness="1">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                
                <VerticalStackLayout>
                    <Grid ColumnDefinitions="Auto,Auto,2*,Auto,Auto,Auto" ColumnSpacing="5"
                          BackgroundColor="{AppThemeBinding Light=#F8F8F8, Dark=#2A2A2A}"
                          Padding="5">
                        
                        <!-- Drag handle for checked items (slightly faded) -->
                        <ContentView Grid.Column="0" 
                                   VerticalOptions="Center"
                                   Opacity="0.6">
                            <Border BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                    WidthRequest="35" 
                                    HeightRequest="35"
                                    StrokeThickness="1"
                                    Stroke="{AppThemeBinding Light=#C0C0C0, Dark=#606060}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="6" />
                                </Border.StrokeShape>
                                <Grid>
                                    <Path Data="M8,4 L8,6 L10,6 L10,4 Z M8,8 L8,10 L10,10 L10,8 Z M8,12 L8,14 L10,14 L10,12 Z M12,4 L12,6 L14,6 L14,4 Z M12,8 L12,10 L14,10 L14,8 Z M12,12 L12,14 L14,14 L14,12 Z"
                                          Fill="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                          HorizontalOptions="Center" 
                                          VerticalOptions="Center"
                                          WidthRequest="18"
                                          HeightRequest="18" />
                                </Grid>
                            </Border>
                        </ContentView>

                        <CheckBox Grid.Column="1" 
                                IsChecked="{Binding IsChecked}"
                                VerticalOptions="Center" />

                        <!-- Nazwa składnika - przekreślona -->
                        <Label Grid.Column="2" 
                               Text="{Binding Name}" 
                               TextDecorations="Strikethrough" 
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                               VerticalTextAlignment="Center"
                               VerticalOptions="Center" />

                        <!-- Ilość - przekreślona -->
                        <Label Grid.Column="3" 
                               Text="{Binding Quantity}" 
                               TextDecorations="Strikethrough" 
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" 
                               VerticalTextAlignment="Center"
                               HorizontalTextAlignment="Center"
                               VerticalOptions="Center" />

                        <!-- Jednostka - przekreślona -->
                        <Label Grid.Column="4" 
                               Text="{Binding Unit}" 
                               TextDecorations="Strikethrough" 
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" 
                               VerticalTextAlignment="Center"
                               HorizontalTextAlignment="Center"
                               VerticalOptions="Center" />

                        <!-- Przycisk usuwania -->
                        <Button Grid.Column="5" 
                                Text="✕" 
                                Command="{Binding BindingContext.RemoveItemCommand, Source={x:Reference ThisPage}}" 
                                CommandParameter="{Binding .}" 
                                WidthRequest="35" 
                                HeightRequest="35"
                                BackgroundColor="{AppThemeBinding Light=#FFE6E6, Dark=#4A2C2C}"
                                TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                FontSize="16"
                                CornerRadius="17"
                                BorderColor="{AppThemeBinding Light=#FFCCCC, Dark=#664444}"
                                BorderWidth="1"
                                Opacity="0.7"
                                VerticalOptions="Center" />
                        
                        <Grid.GestureRecognizers>
                            <DragGestureRecognizer CanDrag="True" 
                                                 DragStartingCommand="{Binding BindingContext.ItemDraggedCommand, Source={x:Reference ThisPage}}"
                                                 DragStartingCommandParameter="{Binding .}" />
                            <DropGestureRecognizer AllowDrop="True" 
                                                 DragLeaveCommand="{Binding BindingContext.ItemDragLeaveCommand, Source={x:Reference ThisPage}}"
                                                 DragLeaveCommandParameter="{Binding .}"
                                                 DragOverCommand="{Binding BindingContext.ItemDraggedOverCommand, Source={x:Reference ThisPage}}"
                                                 DragOverCommandParameter="{Binding .}"
                                                 DropCommand="{Binding BindingContext.ItemDroppedCommand, Source={x:Reference ThisPage}}"
                                                 DropCommandParameter="{Binding .}" />
                        </Grid.GestureRecognizers>
                    </Grid>
                    
                    <!-- Drag over indicator -->
                    <StackLayout BackgroundColor="LightGray"
                               HeightRequest="30"
                               HorizontalOptions="FillAndExpand"
                               IsVisible="{Binding IsBeingDraggedOver}"
                               VerticalOptions="FillAndExpand" />
                </VerticalStackLayout>
            </Border>
        </DataTemplate>
    </ContentPage.Resources>
    
    <ScrollView>
        <StackLayout Padding="10" Spacing="15">
            
            <!-- Sekcja: Produkty do kupienia -->
            <StackLayout Spacing="5">
                <Label FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                       Margin="0,0,0,10"
                       Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=ToBuy}" />
                
                <!-- Lista produktów do kupienia - CollectionView z drag-and-drop -->
                <CollectionView x:Name="UncheckedItemsCollectionView"
                              ItemsSource="{Binding UncheckedItems}"
                              ItemTemplate="{StaticResource ReorderableItemTemplate}"
                              BackgroundColor="Transparent">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="2" />
                    </CollectionView.ItemsLayout>
                </CollectionView>
                
                <Button Command="{Binding AddItemCommand}"
                        Margin="0,10,0,0"
                        Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=AddItem}" />
            </StackLayout>

            <!-- Separator -->
            <BoxView HeightRequest="1" 
                     BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" 
                     Margin="0,10" />

            <!-- Sekcja: Produkty zebrane -->
            <StackLayout Spacing="5">
                <Label FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                       Margin="0,0,0,10"
                       Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=Collected}" />
                
                <!-- Lista produktów zebranych - CollectionView z drag-and-drop -->
                <CollectionView x:Name="CheckedItemsCollectionView"
                              ItemsSource="{Binding CheckedItems}"
                              ItemTemplate="{StaticResource CheckedItemTemplate}"
                              BackgroundColor="Transparent">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="2" />
                    </CollectionView.ItemsLayout>
                </CollectionView>
                
                <!-- Informacja gdy brak zebranych produktów -->
                <Label Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=NoCollected}"
                       TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                       HorizontalTextAlignment="Center"
                       Margin="0,20"
                       IsVisible="{Binding HasCheckedItems, Converter={StaticResource InvertedBoolConverter}}" />
            </StackLayout>
            
        </StackLayout>
    </ScrollView>
</ContentPage>
