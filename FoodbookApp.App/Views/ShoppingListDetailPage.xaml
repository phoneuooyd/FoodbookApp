<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:loc="clr-namespace:Foodbook.Services"
             xmlns:models="clr-namespace:Foodbook.Models"
             xmlns:vm="clr-namespace:Foodbook.ViewModels"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             xmlns:resources="clr-namespace:FoodbookApp.Localization"
             x:Class="Foodbook.Views.ShoppingListDetailPage"
             x:Name="ThisPage"
             x:DataType="vm:ShoppingListDetailViewModel"
             Title="{loc:Translate Resource=ShoppingListDetailPageResources, Key=Title}">
    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
    </ContentPage.Resources>
    
    <ScrollView>
        <StackLayout Padding="10" Spacing="15">
            
            <!-- Sekcja: Produkty do kupienia -->
            <StackLayout Spacing="5">
                <Label FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                       Margin="0,0,0,10"
                       Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=ToBuy}" />
                
                <!-- Lista produktów do kupienia -->
                <CollectionView ItemsSource="{Binding UncheckedItems}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Ingredient">
                            <Frame BorderColor="LightGray" Padding="5" Margin="0,2">
                                <Grid ColumnDefinitions="Auto,Auto,2*,Auto,Auto,Auto" ColumnSpacing="5">
                                    
                                    <!-- Drag Handle - moved to leftmost position -->
                                    <Border Grid.Column="0" 
                                            BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                            WidthRequest="30" 
                                            HeightRequest="30"
                                            StrokeThickness="0">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="4" />
                                        </Border.StrokeShape>
                                        <Border.GestureRecognizers>
                                            <DragGestureRecognizer CanDrag="True" DragStarting="OnItemDragStarting" />
                                            <DropGestureRecognizer AllowDrop="True" Drop="OnItemDropped" DragOver="OnItemDragOver" />
                                        </Border.GestureRecognizers>
                                        <Grid>
                                            <Label Text="⋮⋮" 
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light=#808080, Dark=#C0C0C0}"
                                                   HorizontalOptions="Center" 
                                                   VerticalOptions="Center"
                                                   FontFamily="Monospace" />
                                        </Grid>
                                    </Border>

                                    <CheckBox Grid.Column="1" IsChecked="{Binding IsChecked}" />

                                    <!-- Nazwa składnika -->
                                    <Entry Grid.Column="2" 
                                           Text="{Binding Name}" 
                                           Placeholder="Nazwa" />

                                    <!-- Ilość -->
                                    <Entry Grid.Column="3" 
                                           Text="{Binding Quantity}" 
                                           Keyboard="Numeric" 
                                           WidthRequest="60"
                                           HorizontalTextAlignment="Center" />

                                    <!-- Jednostka -->
                                    <Picker Grid.Column="4" 
                                            WidthRequest="80" 
                                            ItemsSource="{Binding BindingContext.Units, Source={x:Reference ThisPage}}" 
                                            SelectedItem="{Binding Unit}" />

                                    <!-- Przycisk usuwania -->
                                    <Button Grid.Column="5" 
                                            Text="−" 
                                            Command="{Binding BindingContext.RemoveItemCommand, Source={x:Reference ThisPage}}" 
                                            CommandParameter="{Binding .}" 
                                            WidthRequest="40" 
                                            HeightRequest="40"
                                            BackgroundColor="Transparent"
                                            TextColor="Black"
                                            FontSize="20"
                                            CornerRadius="6" />
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                
                <Button Command="{Binding AddItemCommand}"
                        Margin="0,10,0,0"
                        Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=AddItem}" />
            </StackLayout>

            <!-- Separator -->
            <BoxView HeightRequest="1" 
                     BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" 
                     Margin="0,10" />

            <!-- Sekcja: Produkty zebrane -->
            <StackLayout Spacing="5">
                <Label FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                       Margin="0,0,0,10"
                       Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=Collected}" />
                
                <!-- Lista produktów zebranych -->
                <CollectionView ItemsSource="{Binding CheckedItems}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Ingredient">
                            <Frame BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" 
                                   Padding="5" 
                                   Margin="0,2"
                                   BackgroundColor="{AppThemeBinding Light=#F8F8F8, Dark=#2A2A2A}">
                                <Grid ColumnDefinitions="Auto,Auto,2*,Auto,Auto,Auto" ColumnSpacing="5">
                                    
                                    <!-- Drag Handle - moved to leftmost position -->
                                    <Border Grid.Column="0" 
                                            BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                            WidthRequest="30" 
                                            HeightRequest="30"
                                            StrokeThickness="0"
                                            Opacity="0.6">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="4" />
                                        </Border.StrokeShape>
                                        <Border.GestureRecognizers>
                                            <DragGestureRecognizer CanDrag="True" DragStarting="OnItemDragStarting" />
                                            <DropGestureRecognizer AllowDrop="True" Drop="OnItemDropped" DragOver="OnItemDragOver" />
                                        </Border.GestureRecognizers>
                                        <Grid>
                                            <Label Text="⋮⋮" 
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                                   HorizontalOptions="Center" 
                                                   VerticalOptions="Center"
                                                   FontFamily="Monospace" />
                                        </Grid>
                                    </Border>

                                    <CheckBox Grid.Column="1" IsChecked="{Binding IsChecked}" />

                                    <!-- Nazwa składnika - przekreślona -->
                                    <Label Grid.Column="2" 
                                           Text="{Binding Name}" 
                                           TextDecorations="Strikethrough" 
                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                           VerticalTextAlignment="Center" />

                                    <!-- Ilość - przekreślona -->
                                    <Label Grid.Column="3" 
                                           Text="{Binding Quantity}" 
                                           TextDecorations="Strikethrough" 
                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" 
                                           VerticalTextAlignment="Center"
                                           HorizontalTextAlignment="Center" />

                                    <!-- Jednostka - przekreślona -->
                                    <Label Grid.Column="4" 
                                           Text="{Binding Unit}" 
                                           TextDecorations="Strikethrough" 
                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" 
                                           VerticalTextAlignment="Center"
                                           HorizontalTextAlignment="Center" />

                                    <!-- Przycisk usuwania -->
                                    <Button Grid.Column="5" 
                                            Text="−" 
                                            Command="{Binding BindingContext.RemoveItemCommand, Source={x:Reference ThisPage}}" 
                                            CommandParameter="{Binding .}" 
                                            WidthRequest="40" 
                                            HeightRequest="40"
                                            BackgroundColor="Transparent"
                                            TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                            FontSize="20"
                                            CornerRadius="6" />
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                
                <!-- Informacja gdy brak zebranych produktów -->
                <Label Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=NoCollected}"
                       TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                       HorizontalTextAlignment="Center"
                       Margin="0,20"
                       IsVisible="{Binding HasCheckedItems, Converter={StaticResource InvertedBoolConverter}}" />
            </StackLayout>
            
        </StackLayout>
    </ScrollView>
</ContentPage>
