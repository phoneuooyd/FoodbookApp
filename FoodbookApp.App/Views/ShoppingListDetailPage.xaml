<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:loc="clr-namespace:Foodbook.Services"
             xmlns:models="clr-namespace:Foodbook.Models"
             xmlns:vm="clr-namespace:Foodbook.ViewModels"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             xmlns:components="clr-namespace:Foodbook.Views.Components"
             xmlns:sho="http://sharpnado.com"
             x:Class="Foodbook.Views.ShoppingListDetailPage"
             x:Name="ThisPage"
             x:DataType="vm:ShoppingListDetailViewModel"
             Title="{loc:Translate Resource=ShoppingListDetailPageResources, Key=Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">
    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        
        <!-- Section header template -->
        <DataTemplate x:Key="SectionHeaderTemplate" x:DataType="vm:ShoppingListSectionHeader">
            <sho:DraggableViewCell IsDraggable="False">
                <StackLayout Padding="14,12,14,6">
                    <!-- Separator line above "Collected" section -->
                    <BoxView HeightRequest="1" 
                             BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" 
                             Margin="0,0,0,10"
                             IsVisible="{Binding IsCollectedSection}" />
                    
                    <Label FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="{Binding HeaderColor}" 
                           Text="{Binding Title}" />
                </StackLayout>
            </sho:DraggableViewCell>
        </DataTemplate>
        
        <!-- Item template wrapped in DraggableViewCell for drag-and-drop -->
        <DataTemplate x:Key="ShoppingItemTemplate" x:DataType="models:Ingredient">
            <sho:DraggableViewCell x:Name="DraggableViewCell">
                <ContentView>
                    <!-- Reset x:DataType to allow binding to page's BindingContext -->
                    <components:ShoppingListItemComponent 
                        x:DataType="x:Null"
                        RemoveItemCommand="{Binding BindingContext.RemoveItemCommand, Source={x:Reference ThisPage}}"
                        ChangeUnitCommand="{Binding BindingContext.ChangeUnitCommand, Source={x:Reference ThisPage}}"
                        UnitsSource="{Binding BindingContext.Units, Source={x:Reference ThisPage}}"
                        EntryFocused="OnEntryFocused"
                        EntryUnfocused="OnEntryUnfocused"
                        UnitSelectionChanged="OnUnitPickerSelectionChanged" />
                </ContentView>
            </sho:DraggableViewCell>
        </DataTemplate>
        
        <!-- DataTemplateSelector for headers vs items -->
        <components:ShoppingListTemplateSelector x:Key="ShoppingListTemplateSelector"
            HeaderTemplate="{StaticResource SectionHeaderTemplate}"
            ItemTemplate="{StaticResource ShoppingItemTemplate}" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*" Padding="0">
        <!-- Header with save and add buttons only -->
        <Grid Row="0" Padding="10" ColumnDefinitions="*,Auto,Auto" BackgroundColor="Transparent">
            <Button Grid.Column="1" 
                    x:Name="SaveButton" 
                    Command="{Binding SaveAllCommand}" 
                    WidthRequest="44" 
                    HeightRequest="44" 
                    CornerRadius="22" 
                    Padding="0" 
                    Margin="8,0,0,0" 
                    VerticalOptions="Center" 
                    HorizontalOptions="End" 
                    StyleClass="Secondary" 
                    VisualElement.ZIndex="10">
                <Button.ImageSource>
                    <FileImageSource File="save.png" />
                </Button.ImageSource>
                <Button.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding HasUnsavedChanges}" Value="True">
                        <Setter Property="BackgroundColor" Value="{DynamicResource Primary}" />
                        <Setter Property="Opacity" Value="1" />
                    </DataTrigger>
                    <DataTrigger TargetType="Button" Binding="{Binding HasUnsavedChanges}" Value="False">
                        <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#E0E0E0, Dark=#303030}" />
                        <Setter Property="Opacity" Value="0.55" />
                    </DataTrigger>
                </Button.Triggers>
            </Button>
            
            <Button Grid.Column="2" 
                    Command="{Binding AddItemCommand}" 
                    WidthRequest="44" 
                    HeightRequest="44" 
                    CornerRadius="22" 
                    Padding="0" 
                    Margin="8,0,0,0" 
                    Text="+" 
                    VerticalOptions="Center" 
                    HorizontalOptions="End" 
                    StyleClass="Secondary" 
                    VisualElement.ZIndex="10" />
        </Grid>

        <!-- Sharpnado CollectionView with drag-and-drop and vertical layout -->
        <sho:CollectionView Grid.Row="1"
            x:Name="ShoppingCollectionView"
            CollectionLayout="Vertical"
            ItemsSource="{Binding FlatItems}"
            ItemTemplate="{StaticResource ShoppingListTemplateSelector}"
            ItemHeight="120"
            CollectionPadding="0,8,0,80"
            ItemSpacing="4"
            EnableDragAndDrop="True"
            DragAndDropTrigger="LongTap"
            DragAndDropDirection="VerticalOnly"
            DragAndDropStartedCommand="{Binding DragStartedCommand}"
            DragAndDropEndedCommand="{Binding DragEndedCommand}"
            TapCommand="{Binding ItemTappedCommand}" />
    </Grid>
</ContentPage>
