<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:loc="clr-namespace:Foodbook.Services"
             xmlns:models="clr-namespace:Foodbook.Models"
             xmlns:vm="clr-namespace:Foodbook.ViewModels"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             xmlns:resources="clr-namespace:FoodbookApp.Localization"
             x:Class="Foodbook.Views.ShoppingListDetailPage"
             x:Name="ThisPage"
             x:DataType="vm:ShoppingListDetailViewModel"
             Title="{loc:Translate Resource=ShoppingListDetailPageResources, Key=Title}">
    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <converters:DragStateToColorConverter x:Key="DragStateToColorConverter" />
        <converters:DropZoneToColorConverter x:Key="DropZoneToColorConverter" />
        <converters:DropZoneBorderColorConverter x:Key="DropZoneBorderColorConverter" />
        <converters:UnitToLocalizedStringConverter x:Key="UnitToLocalizedStringConverter" />
    </ContentPage.Resources>
    
    <ScrollView>
        <StackLayout Padding="10" Spacing="15">
            
            <!-- Sekcja: Produkty do kupienia -->
            <StackLayout Spacing="5">
                <Label FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                       Margin="0,0,0,10"
                       Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=ToBuy}" />
                
                <!-- Lista produktów do kupienia -->
                <CollectionView ItemsSource="{Binding UncheckedItems}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Ingredient">
                            <Frame BorderColor="{Binding IsBeingDraggedOver, Converter={StaticResource DropZoneBorderColorConverter}}" 
                                   Padding="5" 
                                   Margin="0,2"
                                   BackgroundColor="{Binding IsBeingDraggedOver, Converter={StaticResource DropZoneToColorConverter}}"
                                   CornerRadius="8"
                                   HasShadow="False">
                                
                                <!-- Main item content -->
                                <Grid ColumnDefinitions="Auto,Auto,2*,Auto,Auto,Auto" 
                                      ColumnSpacing="5"
                                      BackgroundColor="{Binding IsBeingDragged, Converter={StaticResource DragStateToColorConverter}}">
                                        
                                    <!-- Drag Handle -->
                                    <StackLayout Grid.Column="0" 
                                                 Orientation="Vertical"
                                                 WidthRequest="30" 
                                                 HeightRequest="30"
                                                 VerticalOptions="Center"
                                                 HorizontalOptions="Center"
                                                 Spacing="2"
                                                 Padding="5">
                                        <!-- Three horizontal lines to create grip handle effect -->
                                        <BoxView BackgroundColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" 
                                                 HeightRequest="2" 
                                                 WidthRequest="20" 
                                                 CornerRadius="1" />
                                        <BoxView BackgroundColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" 
                                                 HeightRequest="2" 
                                                 WidthRequest="20" 
                                                 CornerRadius="1" />
                                        <BoxView BackgroundColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" 
                                                 HeightRequest="2" 
                                                 WidthRequest="20" 
                                                 CornerRadius="1" />
                                            
                                        <!-- Make the drag handle area larger for touch -->
                                        <StackLayout.GestureRecognizers>
                                            <DragGestureRecognizer
                                                CanDrag="True"
                                                DragStartingCommand="{Binding BindingContext.ItemDraggedCommand, Source={x:Reference ThisPage}}"
                                                DragStartingCommandParameter="{Binding .}" />
                                        </StackLayout.GestureRecognizers>
                                    </StackLayout>
                                        
                                    <CheckBox Grid.Column="1" IsChecked="{Binding IsChecked}" />

                                    <!-- Nazwa składnika -->
                                    <Entry Grid.Column="2" 
                                           Text="{Binding Name}" 
                                           Placeholder="Nazwa" />

                                    <!-- Ilość -->
                                    <Entry Grid.Column="3" 
                                           Text="{Binding Quantity}" 
                                           Keyboard="Numeric" 
                                           WidthRequest="60"
                                           HorizontalTextAlignment="Center" />

                                    <!-- Jednostka -->
                                    <Picker Grid.Column="4" 
                                            WidthRequest="80" 
                                            ItemsSource="{Binding BindingContext.Units, Source={x:Reference ThisPage}}" 
                                            SelectedItem="{Binding Unit}"
                                            ItemDisplayBinding="{Binding ., Converter={StaticResource UnitToLocalizedStringConverter}}" />

                                    <!-- Przycisk usuwania -->
                                    <Button Grid.Column="5" 
                                            Text="✕" 
                                            Command="{Binding BindingContext.RemoveItemCommand, Source={x:Reference ThisPage}}" 
                                            CommandParameter="{Binding .}" 
                                            WidthRequest="35" 
                                            HeightRequest="35"
                                            BackgroundColor="{AppThemeBinding Light=#FFE6E6, Dark=#4A2C2C}"
                                            TextColor="{AppThemeBinding Light=#CC0000, Dark=#FF6666}"
                                            FontSize="16"
                                            CornerRadius="17"
                                            BorderColor="{AppThemeBinding Light=#FFCCCC, Dark=#664444}"
                                            BorderWidth="1" />

                                    <!-- Additional Drag and Drop Gesture Recognizers for entire row -->
                                    <Grid.GestureRecognizers>
                                        <DropGestureRecognizer
                                            AllowDrop="True"
                                            DragLeaveCommand="{Binding BindingContext.ItemDragLeaveCommand, Source={x:Reference ThisPage}}"
                                            DragLeaveCommandParameter="{Binding .}"
                                            DragOverCommand="{Binding BindingContext.ItemDraggedOverCommand, Source={x:Reference ThisPage}}"
                                            DragOverCommandParameter="{Binding .}"
                                            DropCommand="{Binding BindingContext.ItemDroppedCommand, Source={x:Reference ThisPage}}"
                                            DropCommandParameter="{Binding .}" />
                                    </Grid.GestureRecognizers>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                
                <Button Command="{Binding AddItemCommand}"
                        Margin="0,10,0,0"
                        Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=AddItem}" />
            </StackLayout>

            <!-- Separator -->
            <BoxView HeightRequest="1" 
                     BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}" 
                     Margin="0,10" />

            <!-- Sekcja: Produkty zebrane -->
            <StackLayout Spacing="5">
                <Label FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                       Margin="0,0,0,10"
                       Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=Collected}" />
                
                <!-- Lista produktów zebranych -->
                <CollectionView ItemsSource="{Binding CheckedItems}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Ingredient">
                            <Frame BorderColor="{Binding IsBeingDraggedOver, Converter={StaticResource DropZoneBorderColorConverter}}" 
                                   Padding="5" 
                                   Margin="0,2"
                                   BackgroundColor="{Binding IsBeingDraggedOver, Converter={StaticResource DropZoneToColorConverter}}"
                                   CornerRadius="8"
                                   HasShadow="False">
                                
                                <!-- Main item content -->
                                <Grid ColumnDefinitions="Auto,Auto,2*,Auto,Auto,Auto" 
                                      ColumnSpacing="5"
                                      BackgroundColor="{Binding IsBeingDragged, Converter={StaticResource DragStateToColorConverter}}">
                                        
                                    <!-- Drag Handle -->
                                    <StackLayout Grid.Column="0" 
                                                 Orientation="Vertical"
                                                 WidthRequest="30" 
                                                 HeightRequest="30"
                                                 VerticalOptions="Center"
                                                 HorizontalOptions="Center"
                                                 Spacing="2"
                                                 Padding="5">
                                        <!-- Three horizontal lines to create grip handle effect -->
                                        <BoxView BackgroundColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" 
                                                 HeightRequest="2" 
                                                 WidthRequest="20" 
                                                 CornerRadius="1" />
                                        <BoxView BackgroundColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" 
                                                 HeightRequest="2" 
                                                 WidthRequest="20" 
                                                 CornerRadius="1" />
                                        <BoxView BackgroundColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" 
                                                 HeightRequest="2" 
                                                 WidthRequest="20" 
                                                 CornerRadius="1" />
                                        
                                        <!-- Make the drag handle area larger for touch -->
                                        <StackLayout.GestureRecognizers>
                                            <DragGestureRecognizer
                                                CanDrag="True"
                                                DragStartingCommand="{Binding BindingContext.ItemDraggedCommand, Source={x:Reference ThisPage}}"
                                                DragStartingCommandParameter="{Binding .}" />
                                        </StackLayout.GestureRecognizers>
                                    </StackLayout>
                                    
                                    <CheckBox Grid.Column="1" IsChecked="{Binding IsChecked}" />

                                    <!-- Nazwa składnika - przekreślona -->
                                    <Label Grid.Column="2" 
                                           Text="{Binding Name}" 
                                           TextDecorations="Strikethrough" 
                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                           VerticalTextAlignment="Center" />

                                    <!-- Ilość - przekreślona -->
                                    <Label Grid.Column="3" 
                                           Text="{Binding Quantity}" 
                                           TextDecorations="Strikethrough" 
                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" 
                                           VerticalTextAlignment="Center"
                                           HorizontalTextAlignment="Center" />

                                    <!-- Jednostka - przekreślona -->
                                    <Label Grid.Column="4" 
                                           Text="{Binding Unit, Converter={StaticResource UnitToLocalizedStringConverter}}" 
                                           TextDecorations="Strikethrough" 
                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" 
                                           VerticalTextAlignment="Center"
                                           HorizontalTextAlignment="Center" />

                                    <!-- Przycisk usuwania -->
                                    <Button Grid.Column="5" 
                                            Text="✕" 
                                            Command="{Binding BindingContext.RemoveItemCommand, Source={x:Reference ThisPage}}" 
                                            CommandParameter="{Binding .}" 
                                            WidthRequest="35" 
                                            HeightRequest="35"
                                            BackgroundColor="{AppThemeBinding Light=#FFE6E6, Dark=#4A2C2C}"
                                            TextColor="{AppThemeBinding Light=#CC0000, Dark=#FF6666}"
                                            FontSize="16"
                                            CornerRadius="17"
                                            BorderColor="{AppThemeBinding Light=#FFCCCC, Dark=#664444}"
                                            BorderWidth="1" />

                                    <!-- Additional Drag and Drop Gesture Recognizers for entire row -->
                                    <Grid.GestureRecognizers>
                                        <DropGestureRecognizer
                                            AllowDrop="True"
                                            DragLeaveCommand="{Binding BindingContext.ItemDragLeaveCommand, Source={x:Reference ThisPage}}"
                                            DragLeaveCommandParameter="{Binding .}"
                                            DragOverCommand="{Binding BindingContext.ItemDraggedOverCommand, Source={x:Reference ThisPage}}"
                                            DragOverCommandParameter="{Binding .}"
                                            DropCommand="{Binding BindingContext.ItemDroppedCommand, Source={x:Reference ThisPage}}"
                                            DropCommandParameter="{Binding .}" />
                                    </Grid.GestureRecognizers>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                
                <!-- Informacja gdy brak zebranych produktów -->
                <Label Text="{loc:Translate Resource=ShoppingListDetailPageResources, Key=NoCollected}"
                       TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                       HorizontalTextAlignment="Center"
                       Margin="0,20"
                       IsVisible="{Binding HasCheckedItems, Converter={StaticResource InvertedBoolConverter}}" />
            </StackLayout>
            
        </StackLayout>
    </ScrollView>
</ContentPage>
