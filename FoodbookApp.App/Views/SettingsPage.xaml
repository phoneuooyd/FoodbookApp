<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Foodbook.ViewModels"
             xmlns:loc="clr-namespace:Foodbook.Services"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             x:Class="Foodbook.Views.SettingsPage"
             x:DataType="vm:SettingsViewModel"
             Title="{loc:Translate Resource=SettingsPageResources, Key=Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">
    <ContentPage.Resources>
        <!-- Converters -->
        <converters:IsNotNullOrEmptyConverter x:Key="IsNotNullOrEmptyConverter" />
        <converters:CultureCodeToLocalizedNameConverter x:Key="CultureCodeToLocalizedNameConverter" />
        <converters:AppThemeToLocalizedStringConverter x:Key="AppThemeToLocalizedStringConverter" />
        <converters:AppColorThemeToLocalizedStringConverter x:Key="AppColorThemeToLocalizedStringConverter" />
        <converters:ThemeToColorConverter x:Key="ThemeToColorConverter" />
        <converters:FontFamilyToLocalizedStringConverter x:Key="FontFamilyToLocalizedStringConverter" />
        <converters:FontSizeToLocalizedStringConverter x:Key="FontSizeToLocalizedStringConverter" />
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        
        <!-- Enhanced Card Style with better separation -->
        <Style x:Key="DashboardCardStyle" TargetType="Frame">
            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}" />
            <Setter Property="HasShadow" Value="True" />
            <Setter Property="CornerRadius" Value="16" />
            <Setter Property="Padding" Value="20" />
            <Setter Property="Margin" Value="12,8" />
            <Setter Property="BorderColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}" />
        </Style>
        
        <!-- Card Title Style -->
        <Style x:Key="CardTitleStyle" TargetType="Label">
            <Setter Property="FontSize" Value="{DynamicResource AppFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="TextColor" Value="{AppThemeBinding Light={DynamicResource Primary}, Dark={DynamicResource Primary}}" />
            <Setter Property="Margin" Value="0,0,0,12" />
            <Setter Property="HorizontalTextAlignment" Value="Center"/>
        </Style>
        
        <!-- Card Button Style -->
        <Style x:Key="CardButtonStyle" TargetType="Button">
            <Setter Property="TextColor" Value="White" />
            <Setter Property="FontSize" Value="{DynamicResource AppFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="HeightRequest" Value="40" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Margin" Value="0,12,0,0" />
        </Style>
        
        <!-- Migration Button Style -->
        <Style x:Key="MigrationButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={DynamicResource Secondary}, Dark={DynamicResource Secondary}}" />
            <Setter Property="TextColor" Value="White" />
            <Setter Property="FontSize" Value="{DynamicResource AppFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="HeightRequest" Value="40" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Margin" Value="0,8,0,0" />
        </Style>
        
        <!-- Danger Button Style -->
        <Style x:Key="DangerButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#DC3545, Dark=#C62D3A}" />
            <Setter Property="TextColor" Value="White" />
            <Setter Property="FontSize" Value="{DynamicResource AppFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="HeightRequest" Value="40" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Margin" Value="0,8,0,0" />
        </Style>
        
        <!-- Status Label Style -->
        <Style x:Key="StatusLabelStyle" TargetType="Label">
            <Setter Property="FontSize" Value="{DynamicResource AppSmallFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="HorizontalTextAlignment" Value="Center" />
            <Setter Property="TextColor" Value="{AppThemeBinding Light={DynamicResource Primary}, Dark={DynamicResource Primary}}" />
            <Setter Property="FontAttributes" Value="Italic" />
            <Setter Property="Margin" Value="0,8,0,0" />
        </Style>
        
        <!-- Description style for consistent text blocks -->
        <Style x:Key="DescriptionStyle" TargetType="Label">
            <Setter Property="FontSize" Value="{DynamicResource AppSmallFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="HorizontalTextAlignment" Value="Center" />
            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}" />
            <Setter Property="Margin" Value="0,0,0,8" />
        </Style>
        
        <!-- Info text style for additional information -->
        <Style x:Key="InfoTextStyle" TargetType="Label">
            <Setter Property="FontSize" Value="{DynamicResource AppSmallFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="HorizontalTextAlignment" Value="Center" />
            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}" />
            <Setter Property="Margin" Value="0,4" />
        </Style>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">
        <!-- Tabs header (like AddRecipePage) -->
        <Grid Grid.Row="0" RowDefinitions="*,3" ColumnDefinitions="*,*,*" HeightRequest="{OnPlatform Default=60, iOS=70}" BackgroundColor="{AppThemeBinding Light=White, Dark=#2D2D30}">
            <Button Grid.Row="0" Grid.Column="0"
                    Text="{loc:Translate Resource=SettingsPageResources, Key=TabLanguage}"
                    Command="{Binding SelectTabCommand}" CommandParameter="0"
                    BackgroundColor="{Binding IsLanguageTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBackground}"
                    TextColor="{Binding IsLanguageTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Text}"
                    FontSize="14"
                    FontAttributes="{Binding IsLanguageTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Bold}"
                    CornerRadius="0" BorderWidth="0" Padding="0" />
            <Button Grid.Row="0" Grid.Column="1"
                    Text="{loc:Translate Resource=SettingsPageResources, Key=TabAppearance}"
                    Command="{Binding SelectTabCommand}" CommandParameter="1"
                    BackgroundColor="{Binding IsAppearanceTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBackground}"
                    TextColor="{Binding IsAppearanceTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Text}"
                    FontSize="14"
                    FontAttributes="{Binding IsAppearanceTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Bold}"
                    CornerRadius="0" BorderWidth="0" Padding="0" />
            <Button Grid.Row="0" Grid.Column="2"
                    Text="{loc:Translate Resource=SettingsPageResources, Key=TabData}"
                    Command="{Binding SelectTabCommand}" CommandParameter="2"
                    BackgroundColor="{Binding IsDataTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBackground}"
                    TextColor="{Binding IsDataTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Text}"
                    FontSize="14"
                    FontAttributes="{Binding IsDataTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Bold}"
                    CornerRadius="0" BorderWidth="0" Padding="0" />
            <BoxView Grid.Row="1" Grid.Column="0" BackgroundColor="{Binding IsLanguageTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBorder}" HeightRequest="3" HorizontalOptions="FillAndExpand" />
            <BoxView Grid.Row="1" Grid.Column="1" BackgroundColor="{Binding IsAppearanceTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBorder}" HeightRequest="3" HorizontalOptions="FillAndExpand" />
            <BoxView Grid.Row="1" Grid.Column="2" BackgroundColor="{Binding IsDataTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBorder}" HeightRequest="3" HorizontalOptions="FillAndExpand" />
        </Grid>

        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="16" Spacing="0" BackgroundColor="{DynamicResource PageBackgroundColor}">
                <!-- Common header -->
                <Frame BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}" 
                       CornerRadius="20" HasShadow="True" Margin="0,0,0,20" Padding="20,16">
                    <StackLayout>
                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=HeaderTitle}"
                               FontSize="{DynamicResource AppTitleFontSize}"
                               FontFamily="{DynamicResource AppFontFamily}"
                               FontAttributes="Bold"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light={DynamicResource Primary}, Dark={DynamicResource Primary}}"
                               Margin="0,4" />
                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=HeaderSubtitle}"
                               FontSize="{DynamicResource AppSmallFontSize}"
                               FontFamily="{DynamicResource AppFontFamily}"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}"
                               Margin="0,0,0,4" />
                    </StackLayout>
                </Frame>

                <!-- LANGUAGE TAB CONTENT -->
                <StackLayout IsVisible="{Binding IsLanguageTabSelected}" Spacing="8">
                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="0" RowSpacing="8">
                        <!-- Language Settings Card -->
                        <Frame Grid.Row="0" Grid.Column="0" Style="{StaticResource DashboardCardStyle}">
                            <StackLayout>
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=LanguageTitle}" Style="{StaticResource CardTitleStyle}" />
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=LanguageDescription}"
                                       Style="{StaticResource DescriptionStyle}" />
                                <Picker ItemsSource="{Binding SupportedCultures}" 
                                        SelectedItem="{Binding SelectedCulture}"
                                        FontSize="{DynamicResource AppFontSize}"
                                        FontFamily="{DynamicResource AppFontFamily}"
                                        ItemDisplayBinding="{Binding ., Converter={StaticResource CultureCodeToLocalizedNameConverter}}" />
                            </StackLayout>
                        </Frame>

                        <!-- Version Info Card -->
                        <Frame Grid.Row="0" Grid.Column="1" Style="{StaticResource DashboardCardStyle}">
                            <StackLayout>
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=VersionInfoTitle}" Style="{StaticResource CardTitleStyle}" />
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=VersionNumber}" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=AuthorLabel}" Style="{StaticResource InfoTextStyle}" />
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=RightsLabel}" Style="{StaticResource InfoTextStyle}" />
                            </StackLayout>
                        </Frame>

                        <!-- Font Family Settings Card -->
                        <Frame Grid.Row="1" Grid.Column="0" Style="{StaticResource DashboardCardStyle}">
                            <StackLayout>
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=FontFamilyTitle}" Style="{StaticResource CardTitleStyle}" />
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=FontFamilyDescription}"
                                       Style="{StaticResource DescriptionStyle}" />
                                <Picker ItemsSource="{Binding SupportedFontFamilies}" 
                                        SelectedItem="{Binding SelectedFontFamily}"
                                        FontSize="{DynamicResource AppFontSize}"
                                        FontFamily="{DynamicResource AppFontFamily}"
                                        ItemDisplayBinding="{Binding ., Converter={StaticResource FontFamilyToLocalizedStringConverter}}" />
                            </StackLayout>
                        </Frame>

                        <!-- Font Size Settings Card -->
                        <Frame Grid.Row="1" Grid.Column="1" Style="{StaticResource DashboardCardStyle}">
                            <StackLayout>
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=FontSizeTitle}" Style="{StaticResource CardTitleStyle}" />
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=FontSizeDescription}"
                                       Style="{StaticResource DescriptionStyle}" />
                                <Picker ItemsSource="{Binding SupportedFontSizes}" 
                                        SelectedItem="{Binding SelectedFontSize}"
                                        FontSize="{DynamicResource AppFontSize}"
                                        FontFamily="{DynamicResource AppFontFamily}"
                                        ItemDisplayBinding="{Binding ., Converter={StaticResource FontSizeToLocalizedStringConverter}}" />
                            </StackLayout>
                        </Frame>
                    </Grid>
                </StackLayout>

                <!-- APPEARANCE TAB CONTENT -->
                <StackLayout IsVisible="{Binding IsAppearanceTabSelected}" Spacing="8">
                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto" ColumnSpacing="0" RowSpacing="8">
                        <!-- Color Theme Settings Card -->
                        <Frame Grid.Row="0" Grid.Column="0" Style="{StaticResource DashboardCardStyle}">
                            <StackLayout>
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=ColorThemeTitle}" Style="{StaticResource CardTitleStyle}" />
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=ColorThemeDescription}"
                                       Style="{StaticResource DescriptionStyle}" />
                                <Picker ItemsSource="{Binding SupportedColorThemes}" 
                                        SelectedItem="{Binding SelectedColorTheme}"
                                        FontSize="{DynamicResource AppFontSize}"
                                        FontFamily="{DynamicResource AppFontFamily}"
                                        ItemDisplayBinding="{Binding ., Converter={StaticResource AppColorThemeToLocalizedStringConverter}}" />
                                
                                <!-- Background options -->
                                <Grid Margin="0,12,0,0" HorizontalOptions="Start" ColumnDefinitions="Auto,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="8">
                                    <CheckBox Grid.Row="0" Grid.Column="0"
                                              IsChecked="{Binding IsColorfulBackgroundEnabled}"
                                              Color="{DynamicResource Primary}"
                                              VerticalOptions="Center" />
                                    <Label Grid.Row="0" Grid.Column="1"
                                           Text="{loc:Translate Resource=SettingsPageResources, Key=ColorfulBackgroundOption}"
                                           FontSize="{DynamicResource AppSmallFontSize}"
                                           FontFamily="{DynamicResource AppFontFamily}"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                                           VerticalOptions="Center" />
                                    <CheckBox Grid.Row="1" Grid.Column="0"
                                              IsChecked="{Binding IsWallpaperBackgroundEnabled}"
                                              IsEnabled="{Binding IsWallpaperAvailable}"
                                              Color="{DynamicResource Primary}"
                                              VerticalOptions="Center" />
                                    <Label Grid.Row="1" Grid.Column="1"
                                           Text="{loc:Translate Resource=SettingsPageResources, Key=WallpaperBackgroundOption}"
                                           FontSize="{DynamicResource AppSmallFontSize}"
                                           FontFamily="{DynamicResource AppFontFamily}"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                                           VerticalOptions="Center" />
                                </Grid>
                                
                                <!-- Theme Preview -->
                                <Grid Margin="0,12,0,0" HeightRequest="40" ColumnDefinitions="*,*,*">
                                    <Ellipse Grid.Column="0" 
                                             Fill="{Binding SelectedColorTheme, Converter={StaticResource ThemeToColorConverter}, ConverterParameter=Primary}"
                                             WidthRequest="32" HeightRequest="32" />
                                    <Ellipse Grid.Column="1"
                                             Fill="{Binding SelectedColorTheme, Converter={StaticResource ThemeToColorConverter}, ConverterParameter=Secondary}"
                                             WidthRequest="32" HeightRequest="32" />
                                    <Ellipse Grid.Column="2"
                                             Fill="{Binding SelectedColorTheme, Converter={StaticResource ThemeToColorConverter}, ConverterParameter=Tertiary}"
                                             WidthRequest="32" HeightRequest="32" />
                                </Grid>
                            </StackLayout>
                        </Frame>

                        <!-- Theme Settings Card -->
                        <Frame Grid.Row="0" Grid.Column="1" Style="{StaticResource DashboardCardStyle}">
                            <StackLayout>
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=ThemeTitle}" Style="{StaticResource CardTitleStyle}" />
                                <Label Text="{loc:Translate Resource=SettingsPageResources, Key=ThemeDescription}"
                                       Style="{StaticResource DescriptionStyle}" />
                                <Picker ItemsSource="{Binding SupportedThemes}" 
                                        SelectedItem="{Binding SelectedTheme}"
                                        FontSize="{DynamicResource AppFontSize}"
                                        FontFamily="{DynamicResource AppFontFamily}"
                                        ItemDisplayBinding="{Binding ., Converter={StaticResource AppThemeToLocalizedStringConverter}}" />
                            </StackLayout>
                        </Frame>
                    </Grid>
                </StackLayout>

                <!-- DATA TAB CONTENT -->
                <StackLayout IsVisible="{Binding IsDataTabSelected}" Spacing="8">
                    <!-- Data Export Card -->
                    <Frame Style="{StaticResource DashboardCardStyle}">
                        <StackLayout>
                            <Label Text="{loc:Translate Resource=SettingsPageResources, Key=DataExportTitle}" Style="{StaticResource CardTitleStyle}" />
                            <Label Text="{loc:Translate Resource=SettingsPageResources, Key=DataExportDescription}" Style="{StaticResource DescriptionStyle}" />
                            <Button Text="Archiwizacja danych" Style="{StaticResource CardButtonStyle}" BackgroundColor="{DynamicResource Primary}" TextColor="White" Clicked="OnOpenArchivizationClicked" />
                        </StackLayout>
                    </Frame>

                    <!-- Database Migration Card -->
                    <Frame Style="{StaticResource DashboardCardStyle}">
                        <StackLayout>
                            <Label Text="{loc:Translate Resource=SettingsPageResources, Key=DatabaseMigrationTitle}" Style="{StaticResource CardTitleStyle}" />
                            <Label Text="{loc:Translate Resource=SettingsPageResources, Key=DatabaseMigrationDescription}" Style="{StaticResource DescriptionStyle}" />
                            <Button Text="{loc:Translate Resource=SettingsPageResources, Key=DatabaseMigrationButton}" Style="{StaticResource MigrationButtonStyle}" Command="{Binding MigrateDatabaseCommand}" IsEnabled="{Binding CanExecuteMigration}" />
                            <Label Text="{Binding MigrationStatus}" Style="{StaticResource StatusLabelStyle}" IsVisible="{Binding MigrationStatus, Converter={StaticResource IsNotNullOrEmptyConverter}}" />
                        </StackLayout>
                    </Frame>

                    <!-- Database Reset Card -->
                    <Frame Style="{StaticResource DashboardCardStyle}">
                        <StackLayout>
                            <Label Text="{loc:Translate Resource=SettingsPageResources, Key=DatabaseResetTitle}" Style="{StaticResource CardTitleStyle}" />
                            <Label Text="{loc:Translate Resource=SettingsPageResources, Key=DatabaseResetDescription}" Style="{StaticResource DescriptionStyle}" />
                            <Button Text="{loc:Translate Resource=SettingsPageResources, Key=DatabaseResetButton}" Style="{StaticResource DangerButtonStyle}" Command="{Binding ResetDatabaseCommand}" IsEnabled="{Binding CanExecuteMigration}" />
                            <Label Text="{loc:Translate Resource=SettingsPageResources, Key=DatabaseResetWarning}" FontSize="{DynamicResource AppSmallFontSize}" HorizontalTextAlignment="Center" TextColor="{AppThemeBinding Light=#DC3545, Dark=#C62D3A}" FontAttributes="Bold" Margin="0,4,0,0" />
                        </StackLayout>
                    </Frame>
                </StackLayout>
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>