<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Foodbook.ViewModels"
             xmlns:loc="clr-namespace:Foodbook.Services"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             xmlns:controls="clr-namespace:Foodbook.Views.Components"
             x:Class="Foodbook.Views.SettingsPage"
             x:DataType="vm:SettingsViewModel"
             Title="{loc:Translate Resource=SettingsPageResources, Key=Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">
    <ContentPage.Resources>
        <!-- Converters -->
        <converters:IsNotNullOrEmptyConverter x:Key="IsNotNullOrEmptyConverter" />
        <converters:CultureCodeToLocalizedNameConverter x:Key="CultureCodeToLocalizedNameConverter" />
        <converters:AppThemeToLocalizedStringConverter x:Key="AppThemeToLocalizedStringConverter" />
        <converters:AppColorThemeToLocalizedStringConverter x:Key="AppColorThemeToLocalizedStringConverter" />
        <converters:ThemeToColorConverter x:Key="ThemeToColorConverter" />
        <converters:FontFamilyToLocalizedStringConverter x:Key="FontFamilyToLocalizedStringConverter" />
        <converters:FontSizeToLocalizedStringConverter x:Key="FontSizeToLocalizedStringConverter" />
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        
        <!-- Enhanced Card Style with better separation -->
        <Style x:Key="DashboardCardStyle" TargetType="Frame">
            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=White, Dark={StaticResource Gray900}}" />
            <Setter Property="HasShadow" Value="True" />
            <Setter Property="CornerRadius" Value="16" />
            <Setter Property="Padding" Value="20" />
            <Setter Property="Margin" Value="12,8" />
            <Setter Property="BorderColor" Value="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}" />
        </Style>
        
        <!-- Card Title Style -->
        <Style x:Key="CardTitleStyle" TargetType="Label">
            <Setter Property="FontSize" Value="{DynamicResource AppFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="TextColor" Value="{AppThemeBinding Light={DynamicResource Primary}, Dark={DynamicResource Primary}}" />
            <Setter Property="Margin" Value="0,0,0,12" />
            <Setter Property="HorizontalTextAlignment" Value="Center"/>
        </Style>
        
        <!-- Card Button Style -->
        <Style x:Key="CardButtonStyle" TargetType="Button">
            <Setter Property="TextColor" Value="White" />
            <Setter Property="FontSize" Value="{DynamicResource AppFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="HeightRequest" Value="40" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Margin" Value="0,12,0,0" />
        </Style>
        
        <!-- Migration Button Style -->
        <Style x:Key="MigrationButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={DynamicResource Primary}, Dark={DynamicResource Primary}}" />
            <Setter Property="TextColor" Value="White" />
            <Setter Property="FontSize" Value="{DynamicResource AppFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="HeightRequest" Value="40" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Margin" Value="0,8,0,0" />
        </Style>
        
        <!-- Danger Button Style -->
        <Style x:Key="DangerButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#DC3545, Dark=#C62D3A}" />
            <Setter Property="TextColor" Value="White" />
            <Setter Property="FontSize" Value="{DynamicResource AppFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="HeightRequest" Value="40" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Margin" Value="0,8,0,0" />
        </Style>
        
        <!-- Status Label Style -->
        <Style x:Key="StatusLabelStyle" TargetType="Label">
            <Setter Property="FontSize" Value="{DynamicResource AppSmallFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="HorizontalTextAlignment" Value="Center" />
            <Setter Property="TextColor" Value="{AppThemeBinding Light={DynamicResource Primary}, Dark={DynamicResource Primary}}" />
            <Setter Property="FontAttributes" Value="Italic" />
            <Setter Property="Margin" Value="0,8,0,0" />
        </Style>
        
        <!-- Description style for consistent text blocks -->
        <Style x:Key="DescriptionStyle" TargetType="Label">
            <Setter Property="FontSize" Value="{DynamicResource AppSmallFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="HorizontalTextAlignment" Value="Center" />
            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray300}}" />
            <Setter Property="Margin" Value="0,0,0,8" />
        </Style>
        
        <!-- Info text style for additional information -->
        <Style x:Key="InfoTextStyle" TargetType="Label">
            <Setter Property="FontSize" Value="{DynamicResource AppSmallFontSize}" />
            <Setter Property="FontFamily" Value="{DynamicResource AppFontFamily}" />
            <Setter Property="HorizontalTextAlignment" Value="Center" />
            <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}" />
            <Setter Property="Margin" Value="0,4" />
        </Style>
    </ContentPage.Resources>

    <controls:TabComponent SelectedIndex="{Binding SelectedTabIndex}" SelectTabCommand="{Binding SelectTabCommand}">
        <controls:TabComponent.Tabs>
            <!-- LANGUAGE TAB -->
            <controls:TabItem Name="{loc:Translate Resource=SettingsPageResources, Key=TabLanguage}">
                <controls:TabItem.Content>
                    <ScrollView>
                        <VerticalStackLayout Padding="16" Spacing="8" BackgroundColor="{DynamicResource PageBackgroundColor}">
                            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="0" RowSpacing="8">
                                <!-- Language Settings Card -->
                                <Frame Grid.Row="0" Grid.Column="0" Style="{StaticResource DashboardCardStyle}">
                                    <StackLayout>
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=LanguageTitle}" Style="{StaticResource CardTitleStyle}" />
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=LanguageDescription}" Style="{StaticResource DescriptionStyle}" />
                                        <Picker ItemsSource="{Binding SupportedCultures}" SelectedItem="{Binding SelectedCulture}"
                                                FontSize="{DynamicResource AppFontSize}" FontFamily="{DynamicResource AppFontFamily}"
                                                ItemDisplayBinding="{Binding ., Converter={StaticResource CultureCodeToLocalizedNameConverter}}" />
                                    </StackLayout>
                                </Frame>

                                <!-- Version Info Card -->
                                <Frame Grid.Row="0" Grid.Column="1" Style="{StaticResource DashboardCardStyle}">
                                    <StackLayout>
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=VersionInfoTitle}" Style="{StaticResource CardTitleStyle}" />
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=VersionNumber}" FontAttributes="Bold" HorizontalTextAlignment="Center" />
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=AuthorLabel}" Style="{StaticResource InfoTextStyle}" />
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=RightsLabel}" Style="{StaticResource InfoTextStyle}" />
                                    </StackLayout>
                                </Frame>

                                <!-- Font Family Settings Card -->
                                <Frame Grid.Row="1" Grid.Column="0" Style="{StaticResource DashboardCardStyle}">
                                    <StackLayout>
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=FontFamilyTitle}" Style="{StaticResource CardTitleStyle}" />
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=FontFamilyDescription}" Style="{StaticResource DescriptionStyle}" />
                                        <Picker ItemsSource="{Binding SupportedFontFamilies}" SelectedItem="{Binding SelectedFontFamily}"
                                                FontSize="{DynamicResource AppFontSize}" FontFamily="{DynamicResource AppFontFamily}"
                                                ItemDisplayBinding="{Binding ., Converter={StaticResource FontFamilyToLocalizedStringConverter}}" />
                                    </StackLayout>
                                </Frame>

                                <!-- Font Size Settings Card -->
                                <Frame Grid.Row="1" Grid.Column="1" Style="{StaticResource DashboardCardStyle}">
                                    <StackLayout>
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=FontSizeTitle}" Style="{StaticResource CardTitleStyle}" />
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=FontSizeDescription}" Style="{StaticResource DescriptionStyle}" />
                                        <Picker ItemsSource="{Binding SupportedFontSizes}" SelectedItem="{Binding SelectedFontSize}"
                                                FontSize="{DynamicResource AppFontSize}" FontFamily="{DynamicResource AppFontFamily}"
                                                ItemDisplayBinding="{Binding ., Converter={StaticResource FontSizeToLocalizedStringConverter}}" />
                                    </StackLayout>
                                </Frame>
                            </Grid>
                        </VerticalStackLayout>
                    </ScrollView>
                </controls:TabItem.Content>
            </controls:TabItem>

            <!-- APPEARANCE TAB -->
            <controls:TabItem Name="{loc:Translate Resource=SettingsPageResources, Key=TabAppearance}">
                <controls:TabItem.Content>
                    <ScrollView>
                        <VerticalStackLayout Padding="16" Spacing="8" BackgroundColor="{DynamicResource PageBackgroundColor}">
                            <Grid ColumnDefinitions="*" RowDefinitions="Auto,Auto" ColumnSpacing="0" RowSpacing="8">
                                <!-- Color Theme Settings Card -->
                                <Frame Grid.Row="0" Grid.Column="0" Style="{StaticResource DashboardCardStyle}">
                                    <StackLayout>
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=ColorThemeTitle}" Style="{StaticResource CardTitleStyle}" />
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=ColorThemeDescription}" Style="{StaticResource DescriptionStyle}" />
                                        <Picker ItemsSource="{Binding SupportedColorThemes}" SelectedItem="{Binding SelectedColorTheme}"
                                                FontSize="{DynamicResource AppFontSize}" FontFamily="{DynamicResource AppFontFamily}"
                                                ItemDisplayBinding="{Binding ., Converter={StaticResource AppColorThemeToLocalizedStringConverter}}" />
                                        
                                        <!-- Background options -->
                                        <Grid Margin="0,12,0,0" HorizontalOptions="Start" ColumnDefinitions="Auto,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="8">
                                            <CheckBox Grid.Row="0" Grid.Column="0" IsChecked="{Binding IsColorfulBackgroundEnabled}" Color="{DynamicResource Primary}" VerticalOptions="Center" />
                                            <Label Grid.Row="0" Grid.Column="1" Text="{loc:Translate Resource=SettingsPageResources, Key=ColorfulBackgroundOption}" FontSize="{DynamicResource AppSmallFontSize}" FontFamily="{DynamicResource AppFontFamily}" TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" VerticalOptions="Center" />

                                            <CheckBox Grid.Row="1" Grid.Column="0" IsChecked="{Binding IsWallpaperBackgroundEnabled}" IsEnabled="{Binding IsWallpaperAvailable}" Color="{DynamicResource Primary}" VerticalOptions="Center" />
                                            <Label Grid.Row="1" Grid.Column="1" Text="{loc:Translate Resource=SettingsPageResources, Key=WallpaperBackgroundOption}" FontSize="{DynamicResource AppSmallFontSize}" FontFamily="{DynamicResource AppFontFamily}" TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" VerticalOptions="Center" />
                                        </Grid>
                                        
                                        <!-- Theme Preview -->
                                        <Grid Margin="0,12,0,0" HeightRequest="40" ColumnDefinitions="*,*,*">
                                            <Ellipse Grid.Column="0" Fill="{Binding SelectedColorTheme, Converter={StaticResource ThemeToColorConverter}, ConverterParameter=Primary}" WidthRequest="32" HeightRequest="32" />
                                            <Ellipse Grid.Column="1" Fill="{Binding SelectedColorTheme, Converter={StaticResource ThemeToColorConverter}, ConverterParameter=Secondary}" WidthRequest="32" HeightRequest="32" />
                                            <Ellipse Grid.Column="2" Fill="{Binding SelectedColorTheme, Converter={StaticResource ThemeToColorConverter}, ConverterParameter=Tertiary}" WidthRequest="32" HeightRequest="32" />
                                        </Grid>
                                    </StackLayout>
                                </Frame>

                                <!-- Theme Settings Card -->
                                <Frame Grid.Row="1" Grid.Column="0" Style="{StaticResource DashboardCardStyle}">
                                    <StackLayout>
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=ThemeTitle}" Style="{StaticResource CardTitleStyle}" />
                                        <Label Text="{loc:Translate Resource=SettingsPageResources, Key=ThemeDescription}" Style="{StaticResource DescriptionStyle}" />
                                        <Picker ItemsSource="{Binding SupportedThemes}" SelectedItem="{Binding SelectedTheme}"
                                                FontSize="{DynamicResource AppFontSize}" FontFamily="{DynamicResource AppFontFamily}"
                                                ItemDisplayBinding="{Binding ., Converter={StaticResource AppThemeToLocalizedStringConverter}}" />
                                    </StackLayout>
                                </Frame>
                            </Grid>
                        </VerticalStackLayout>
                    </ScrollView>
                </controls:TabItem.Content>
            </controls:TabItem>

            <!-- DATA TAB -->
            <controls:TabItem Name="{loc:Translate Resource=SettingsPageResources, Key=TabData}">
                <controls:TabItem.Content>
                    <ScrollView>
                        <VerticalStackLayout Padding="16" Spacing="8" BackgroundColor="{DynamicResource PageBackgroundColor}">
                            <!-- NEW: Update Ingredients Card at the very top of Data section -->
                            <Frame Style="{StaticResource DashboardCardStyle}">
                                <StackLayout>
                                    <Label Text="{loc:Translate Resource=SettingsPageResources, Key=UpdateIngredientsTitle}" Style="{StaticResource CardTitleStyle}" />
                                    <Label Text="{loc:Translate Resource=SettingsPageResources, Key=UpdateIngredientsDescription}" Style="{StaticResource DescriptionStyle}" />
                                    <Button Text="{loc:Translate Resource=SettingsPageResources, Key=UpdateIngredientsButton}" Style="{StaticResource MigrationButtonStyle}" Clicked="OnUpdateIngredientsClicked" />
                                </StackLayout>
                            </Frame>

                            <!-- Data Export Card -->
                            <Frame Style="{StaticResource DashboardCardStyle}">
                                <StackLayout>
                                    <Label Text="{loc:Translate Resource=SettingsPageResources, Key=DataExportTitle}" Style="{StaticResource CardTitleStyle}" />
                                    <Label Text="{loc:Translate Resource=SettingsPageResources, Key=DataExportDescription}" Style="{StaticResource DescriptionStyle}" />
                                    <Button Text="{loc:Translate Resource=SettingsPageResources, Key=DataExportButton}" Style="{StaticResource MigrationButtonStyle}" Clicked="OnOpenArchivizationClicked" />
                                </StackLayout>
                            </Frame>

                            <!-- Database Migration Card -->
                            <Frame Style="{StaticResource DashboardCardStyle}">
                                <StackLayout>
                                    <Label Text="{loc:Translate Resource=SettingsPageResources, Key=DatabaseMigrationTitle}" Style="{StaticResource CardTitleStyle}" />
                                    <Label Text="{loc:Translate Resource=SettingsPageResources, Key=DatabaseMigrationDescription}" Style="{StaticResource DescriptionStyle}" />
                                    <Button Text="{loc:Translate Resource=SettingsPageResources, Key=DatabaseMigrationButton}" Style="{StaticResource MigrationButtonStyle}" Command="{Binding MigrateDatabaseCommand}" IsEnabled="{Binding CanExecuteMigration}" />
                                    <Label Text="{Binding MigrationStatus}" Style="{StaticResource StatusLabelStyle}" IsVisible="{Binding MigrationStatus, Converter={StaticResource IsNotNullOrEmptyConverter}}" />
                                </StackLayout>
                            </Frame>

                            <!-- Factory Reset Card -->
                            <Frame Style="{StaticResource DashboardCardStyle}">
                                <StackLayout>
                                    <Label Text="{loc:Translate Resource=SettingsPageResources, Key=FactoryResetTitle}" Style="{StaticResource CardTitleStyle}" />
                                    <Label Text="{loc:Translate Resource=SettingsPageResources, Key=FactoryResetDescription}" Style="{StaticResource DescriptionStyle}" />
                                    <Button Text="{loc:Translate Resource=SettingsPageResources, Key=FactoryResetButton}" Style="{StaticResource DangerButtonStyle}" Command="{Binding FactoryResetCommand}" IsEnabled="{Binding CanExecuteMigration}" />
                                    <Label Text="{loc:Translate Resource=SettingsPageResources, Key=FactoryResetWarning}" FontSize="{DynamicResource AppSmallFontSize}" HorizontalTextAlignment="Center" TextColor="{AppThemeBinding Light=#DC3545, Dark=#C62D3A}" FontAttributes="Bold" Margin="0,4,0,0" />
                                </StackLayout>
                            </Frame>
                        </VerticalStackLayout>
                    </ScrollView>
                </controls:TabItem.Content>
            </controls:TabItem>
        </controls:TabComponent.Tabs>
    </controls:TabComponent>
</ContentPage>