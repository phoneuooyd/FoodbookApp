<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:loc="clr-namespace:Foodbook.Services"
             xmlns:models="clr-namespace:Foodbook.Models"
             xmlns:vm="clr-namespace:Foodbook.ViewModels"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             xmlns:resources="clr-namespace:FoodbookApp.Localization"
             xmlns:controls="clr-namespace:Foodbook.Views.Components"
             x:Class="Foodbook.Views.AddRecipePage"
             x:Name="ThisPage"
             x:DataType="vm:AddRecipeViewModel"
             Title="{Binding Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">
    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        <converters:StringToBoolConverter x:Key="StringToBoolConverter" />
        <converters:UnitToLocalizedStringConverter x:Key="UnitToStringConverter" />
        <converters:LabelSelectionToBorderConverter x:Key="LabelSelectionToBorderConverter" />
    </ContentPage.Resources>
    <Grid RowDefinitions="Auto,*">
        <Grid Grid.Row="0" RowDefinitions="*,3" ColumnDefinitions="*,*,*" HeightRequest="{OnPlatform Default=60, iOS=70}" BackgroundColor="{AppThemeBinding Light=White, Dark=#2D2D30}">
            <!-- Tabs -->
            <Button Grid.Row="0" Grid.Column="0" Text="{loc:Translate Resource=AddRecipePageResources, Key=BasicInfoTab}" Command="{Binding SelectTabCommand}" CommandParameter="0" BackgroundColor="{Binding IsBasicInfoTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBackground}" TextColor="{Binding IsBasicInfoTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Text}" FontSize="14" FontAttributes="{Binding IsBasicInfoTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Bold}" CornerRadius="0" BorderWidth="0" Padding="0" />
            <Button Grid.Row="0" Grid.Column="1" Text="{loc:Translate Resource=AddRecipePageResources, Key=IngredientsTab}" Command="{Binding SelectTabCommand}" CommandParameter="1" BackgroundColor="{Binding IsIngredientsTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBackground}" TextColor="{Binding IsIngredientsTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Text}" FontSize="14" FontAttributes="{Binding IsIngredientsTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Bold}" CornerRadius="0" BorderWidth="0" Padding="0" />
            <Button Grid.Row="0" Grid.Column="2" Text="{loc:Translate Resource=AddRecipePageResources, Key=NutritionTab}" Command="{Binding SelectTabCommand}" CommandParameter="2" BackgroundColor="{Binding IsNutritionTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBackground}" TextColor="{Binding IsNutritionTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Text}" FontSize="14" FontAttributes="{Binding IsNutritionTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Bold}" CornerRadius="0" BorderWidth="0" Padding="0" />
            <BoxView Grid.Row="1" Grid.Column="0" BackgroundColor="{Binding IsBasicInfoTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBorder}" HeightRequest="3" HorizontalOptions="FillAndExpand" />
            <BoxView Grid.Row="1" Grid.Column="1" BackgroundColor="{Binding IsIngredientsTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBorder}" HeightRequest="3" HorizontalOptions="FillAndExpand" />
            <BoxView Grid.Row="1" Grid.Column="2" BackgroundColor="{AppThemeBinding Light=#E1E1E1, Dark=#404040}" HeightRequest="1" HorizontalOptions="FillAndExpand" VerticalOptions="End" />
        </Grid>
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="20" Spacing="15">
                <!-- Tab 1 -->
                <StackLayout IsVisible="{Binding IsBasicInfoTabSelected}" Spacing="15">
                    <!-- Mode Selection -->
                    <StackLayout Spacing="10">
                        <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=ModeSelection}" FontSize="18" FontAttributes="Bold" />
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                            <Button Grid.Column="0" Command="{Binding SetManualModeCommand}" BackgroundColor="{Binding IsManualMode, Converter={StaticResource BoolToColorConverter}, ConverterParameter=SegmentSelectedBg}" TextColor="{Binding IsManualMode, Converter={StaticResource BoolToColorConverter}, ConverterParameter=SegmentText}" HeightRequest="45" Text="{loc:Translate Resource=AddRecipePageResources, Key=Manual}" />
                            <Button Grid.Column="1" Command="{Binding SetImportModeCommand}" BackgroundColor="{Binding IsImportMode, Converter={StaticResource BoolToColorConverter}, ConverterParameter=SegmentSelectedBg}" TextColor="{Binding IsImportMode, Converter={StaticResource BoolToColorConverter}, ConverterParameter=SegmentText}" HeightRequest="45" Text="{loc:Translate Resource=AddRecipePageResources, Key=FromLink}" />
                        </Grid>
                    </StackLayout>
                    <!-- Import Section -->
                    <StackLayout IsVisible="{Binding IsImportMode}" Spacing="10">
                        <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=ImportHeader}" FontSize="18" FontAttributes="Bold" Margin="0,10,0,5" />
                        <StackLayout Spacing="5">
                            <Frame BorderColor="{StaticResource ModernBorderColor}" CornerRadius="12" Padding="0">
                                <StackLayout Spacing="5" Padding="12,8">
                                    <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=UrlLabel}" Style="{StaticResource FieldLabel}" />
                                    <Entry Placeholder="{loc:Translate Resource=AddRecipePageResources, Key=UrlPlaceholder}" Text="{Binding ImportUrl}" ClearButtonVisibility="WhileEditing" Keyboard="Url" Style="{StaticResource ModernEntry}" />
                                </StackLayout>
                            </Frame>
                        </StackLayout>
                        <Button Command="{Binding ImportRecipeCommand}" BackgroundColor="{DynamicResource Primary}" HeightRequest="45" Text="{loc:Translate Resource=AddRecipePageResources, Key=ImportButton}" />
                        <Label Text="{Binding ImportStatus}" FontSize="12" HorizontalTextAlignment="Center" IsVisible="{Binding ImportStatus, Converter={StaticResource StringToBoolConverter}}" />
                    </StackLayout>
                    <!-- Manual Section -->
                    <StackLayout IsVisible="{Binding IsManualMode}" Spacing="10">
                        <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=BasicInfoHeader}" FontSize="18" FontAttributes="Bold" Margin="0,10,0,5" />
                        <Frame BorderColor="{StaticResource ModernBorderColor}" CornerRadius="12" Padding="0">
                            <StackLayout Spacing="5" Padding="12,8">
                                <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=NameLabel}" Style="{StaticResource FieldLabel}" />
                                <Entry Placeholder="{loc:Translate Resource=AddRecipePageResources, Key=NamePlaceholder}" Text="{Binding Name}" ClearButtonVisibility="WhileEditing" Style="{StaticResource ModernEntry}" />
                            </StackLayout>
                        </Frame>
                        <Frame BorderColor="{StaticResource ModernBorderColor}" CornerRadius="12" Padding="0">
                            <StackLayout Spacing="5" Padding="12,8">
                                <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=DescriptionLabel}" Style="{StaticResource FieldLabel}" />
                                <Editor Placeholder="{loc:Translate Resource=AddRecipePageResources, Key=DescriptionPlaceholder}" Text="{Binding Description}" AutoSize="TextChanges" MinimumHeightRequest="120" MaximumHeightRequest="300" BackgroundColor="Transparent" />
                            </StackLayout>
                        </Frame>
                        <Frame BorderColor="{StaticResource ModernBorderColor}" CornerRadius="12" Padding="0">
                            <StackLayout Spacing="5" Padding="12,8">
                                <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=PortionsLabel}" Style="{StaticResource FieldLabel}" />
                                <Entry Placeholder="2" Keyboard="Numeric" Text="{Binding IloscPorcji}" ClearButtonVisibility="WhileEditing" HorizontalTextAlignment="Center" WidthRequest="100" HorizontalOptions="Start" Style="{StaticResource ModernEntry}" />
                            </StackLayout>
                        </Frame>
                    </StackLayout>
                    <!-- Labels assign panel (always visible on tab 1) -->
                    <Frame BorderColor="{StaticResource ModernBorderColor}" CornerRadius="12" Padding="0">
                        <StackLayout Spacing="8" Padding="12,8">
                            <!-- Header row with title and manage button -->
                            <Grid ColumnDefinitions="*,Auto" Margin="0,0,0,4">
                                <Label Grid.Column="0"
                                       Text="Etykiety" 
                                       Style="{StaticResource FieldLabel}" 
                                       VerticalOptions="Center" />
                                <Button Grid.Column="1"
                                        Text="+"
                                        Clicked="OnManageLabelsClicked"
                                        WidthRequest="36"
                                        HeightRequest="36"
                                        Padding="0"
                                        BackgroundColor="{DynamicResource Primary}"
                                        TextColor="White"
                                        CornerRadius="18" />
                            </Grid>
                            <!-- Labels list -->
                            <CollectionView x:Name="LabelsCollectionView"
                                            ItemsSource="{Binding AvailableLabels}"
                                            SelectionMode="Multiple"
                                            SelectionChanged="OnLabelsSelectionChanged">
                                <CollectionView.ItemsLayout>
                                    <GridItemsLayout Orientation="Vertical" Span="2" />
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:RecipeLabel">
                                        <Frame HasShadow="False" 
                                               Padding="8" 
                                               CornerRadius="12" 
                                               Margin="4"
                                               BackgroundColor="{AppThemeBinding Light=#F2F2F7, Dark=#2C2C2E}"
                                               BorderColor="{Binding IsSelected, Converter={StaticResource LabelSelectionToBorderConverter}, ConverterParameter={x:Reference ThisPage}}">
                                            <Label Text="{Binding Name}" />
                                        </Frame>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </StackLayout>
                    </Frame>
                </StackLayout>
                <!-- Other tabs content can be added here as needed -->
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
