<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:loc="clr-namespace:Foodbook.Services"
             xmlns:models="clr-namespace:Foodbook.Models"
             xmlns:vm="clr-namespace:Foodbook.ViewModels"
             xmlns:converters="clr-namespace:Foodbook.Converters"
             xmlns:resources="clr-namespace:FoodbookApp.Localization"
             x:Class="Foodbook.Views.AddRecipePage"
             x:Name="ThisPage"
             x:DataType="vm:AddRecipeViewModel"
             Title="{Binding Title}"
             BackgroundColor="{DynamicResource PageBackgroundColor}">
    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        <converters:StringToBoolConverter x:Key="StringToBoolConverter" />
    </ContentPage.Resources>
    <Grid RowDefinitions="Auto,*">
        <Grid Grid.Row="0" RowDefinitions="*,3" ColumnDefinitions="*,*,*" HeightRequest="{OnPlatform Default=60, iOS=70}" BackgroundColor="{AppThemeBinding Light=White, Dark=#2D2D30}">
            <!-- Tabs -->
            <Button Grid.Row="0" Grid.Column="0" Text="{loc:Translate Resource=AddRecipePageResources, Key=BasicInfoTab}" Command="{Binding SelectTabCommand}" CommandParameter="0" BackgroundColor="{Binding IsBasicInfoTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBackground}" TextColor="{Binding IsBasicInfoTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Text}" FontSize="14" FontAttributes="{Binding IsBasicInfoTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Bold}" CornerRadius="0" BorderWidth="0" Padding="0" />
            <Button Grid.Row="0" Grid.Column="1" Text="{loc:Translate Resource=AddRecipePageResources, Key=IngredientsTab}" Command="{Binding SelectTabCommand}" CommandParameter="1" BackgroundColor="{Binding IsIngredientsTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBackground}" TextColor="{Binding IsIngredientsTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Text}" FontSize="14" FontAttributes="{Binding IsIngredientsTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Bold}" CornerRadius="0" BorderWidth="0" Padding="0" />
            <Button Grid.Row="0" Grid.Column="2" Text="{loc:Translate Resource=AddRecipePageResources, Key=NutritionTab}" Command="{Binding SelectTabCommand}" CommandParameter="2" BackgroundColor="{Binding IsNutritionTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBackground}" TextColor="{Binding IsNutritionTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Text}" FontSize="14" FontAttributes="{Binding IsNutritionTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=Bold}" CornerRadius="0" BorderWidth="0" Padding="0" />
            <BoxView Grid.Row="1" Grid.Column="0" BackgroundColor="{Binding IsBasicInfoTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBorder}" HeightRequest="3" HorizontalOptions="FillAndExpand" />
            <BoxView Grid.Row="1" Grid.Column="1" BackgroundColor="{Binding IsIngredientsTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBorder}" HeightRequest="3" HorizontalOptions="FillAndExpand" />
            <BoxView Grid.Row="1" Grid.Column="2" BackgroundColor="{Binding IsNutritionTabSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=TabBorder}" HeightRequest="3" HorizontalOptions="FillAndExpand" />
            <BoxView Grid.Row="1" Grid.ColumnSpan="3" BackgroundColor="{AppThemeBinding Light=#E1E1E1, Dark=#404040}" HeightRequest="1" HorizontalOptions="FillAndExpand" VerticalOptions="End" />
        </Grid>
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="20" Spacing="15">
                <!-- Tab 1 -->
                <StackLayout IsVisible="{Binding IsBasicInfoTabSelected}" Spacing="15">
                    <!-- Mode Selection -->
                    <StackLayout Spacing="10">
                        <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=ModeSelection}" FontSize="18" FontAttributes="Bold" />
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                            <Button Grid.Column="0" Command="{Binding SetManualModeCommand}" BackgroundColor="{Binding IsManualMode, Converter={StaticResource BoolToColorConverter}, ConverterParameter=SegmentSelectedBg}" TextColor="{Binding IsManualMode, Converter={StaticResource BoolToColorConverter}, ConverterParameter=SegmentText}" HeightRequest="45" Text="{loc:Translate Resource=AddRecipePageResources, Key=Manual}" />
                            <Button Grid.Column="1" Command="{Binding SetImportModeCommand}" BackgroundColor="{Binding IsImportMode, Converter={StaticResource BoolToColorConverter}, ConverterParameter=SegmentSelectedBg}" TextColor="{Binding IsImportMode, Converter={StaticResource BoolToColorConverter}, ConverterParameter=SegmentText}" HeightRequest="45" Text="{loc:Translate Resource=AddRecipePageResources, Key=FromLink}" />
                        </Grid>
                    </StackLayout>
                    <!-- Import Section -->
                    <StackLayout IsVisible="{Binding IsImportMode}" Spacing="10">
                        <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=ImportHeader}" FontSize="18" FontAttributes="Bold" Margin="0,10,0,5" />
                        <StackLayout Spacing="5">
                            <Frame BorderColor="LightGray" Padding="8" CornerRadius="8">
                                <StackLayout Spacing="5">
                                    <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=UrlLabel}" FontAttributes="Bold" FontSize="14" />
                                    <Entry Placeholder="{loc:Translate Resource=AddRecipePageResources, Key=UrlPlaceholder}" Text="{Binding ImportUrl}" ClearButtonVisibility="WhileEditing" Keyboard="Url" FontSize="16" />
                                </StackLayout>
                            </Frame>
                        </StackLayout>
                        <Button Command="{Binding ImportRecipeCommand}" BackgroundColor="{DynamicResource Primary}" HeightRequest="45" Text="{loc:Translate Resource=AddRecipePageResources, Key=ImportButton}" />
                        <Label Text="{Binding ImportStatus}" FontSize="12" HorizontalTextAlignment="Center" IsVisible="{Binding ImportStatus, Converter={StaticResource StringToBoolConverter}}" />
                    </StackLayout>
                    <!-- Manual Section -->
                    <StackLayout IsVisible="{Binding IsManualMode}" Spacing="10">
                        <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=BasicInfoHeader}" FontSize="18" FontAttributes="Bold" Margin="0,10,0,5" />
                        <Frame BorderColor="LightGray" Padding="8" CornerRadius="8">
                            <StackLayout Spacing="5">
                                <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=NameLabel}" FontAttributes="Bold" FontSize="14" />
                                <Entry Placeholder="{loc:Translate Resource=AddRecipePageResources, Key=NamePlaceholder}" Text="{Binding Name}" ClearButtonVisibility="WhileEditing" FontSize="16" />
                            </StackLayout>
                        </Frame>
                        <Frame BorderColor="LightGray" Padding="8" CornerRadius="8">
                            <StackLayout Spacing="5">
                                <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=DescriptionLabel}" FontAttributes="Bold" FontSize="14" />
                                <Editor Placeholder="{loc:Translate Resource=AddRecipePageResources, Key=DescriptionPlaceholder}" Text="{Binding Description}" AutoSize="TextChanges" MinimumHeightRequest="120" MaximumHeightRequest="300" />
                            </StackLayout>
                        </Frame>
                        <Frame BorderColor="LightGray" Padding="8" CornerRadius="8">
                            <StackLayout Spacing="5">
                                <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=PortionsLabel}" FontAttributes="Bold" FontSize="14" />
                                <Entry Placeholder="2" Keyboard="Numeric" Text="{Binding IloscPorcji}" ClearButtonVisibility="WhileEditing" HorizontalTextAlignment="Center" WidthRequest="100" HorizontalOptions="Start" FontSize="16" />
                            </StackLayout>
                        </Frame>
                    </StackLayout>
                </StackLayout>
                <!-- Ingredients Tab -->
                <StackLayout IsVisible="{Binding IsIngredientsTabSelected}" Spacing="15">
                    <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=IngredientsHeader}" FontSize="18" FontAttributes="Bold" Margin="0,0,0,5" />
                    <CollectionView ItemsSource="{Binding Ingredients}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Ingredient">
                                <Frame BorderColor="LightGray" Padding="10" Margin="0,3">
                                    <Grid ColumnDefinitions="2*,*,Auto,Auto" ColumnSpacing="8" RowDefinitions="Auto,Auto" RowSpacing="8">
                                        <StackLayout Grid.Row="0" Grid.Column="0" Spacing="3">
                                            <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=IngredientLabel}" FontSize="12" FontAttributes="Bold" />
                                            <Picker Title="{loc:Translate Resource=AddRecipePageResources, Key=ChooseIngredient}" ItemsSource="{Binding BindingContext.AvailableIngredientNames, Source={x:Reference ThisPage}}" SelectedItem="{Binding Name}" SelectedIndexChanged="OnIngredientNameChanged" />
                                        </StackLayout>
                                        <StackLayout Grid.Row="0" Grid.Column="1" Spacing="3">
                                            <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=QuantityLabelShort}" FontSize="12" FontAttributes="Bold" />
                                            <Entry Placeholder="1.0" Keyboard="Numeric" Text="{Binding Quantity}" HorizontalTextAlignment="Center" TextChanged="OnIngredientValueChanged" />
                                        </StackLayout>
                                        <StackLayout Grid.Row="0" Grid.Column="2" Spacing="3">
                                            <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=UnitLabelShort}" FontSize="12" FontAttributes="Bold" />
                                            <Picker Title="{loc:Translate Resource=AddRecipePageResources, Key=UnitLabelShort}" ItemsSource="{Binding BindingContext.Units, Source={x:Reference ThisPage}}" SelectedItem="{Binding Unit}" SelectedIndexChanged="OnIngredientValueChanged" WidthRequest="90" />
                                        </StackLayout>
                                        <Button Grid.Row="0" Grid.Column="3" Text="âœ•" Command="{Binding BindingContext.RemoveIngredientCommand, Source={x:Reference ThisPage}}" CommandParameter="{Binding .}" WidthRequest="35" HeightRequest="35" BackgroundColor="{AppThemeBinding Light=#FFE6E6, Dark=#4A2C2C}" TextColor="{AppThemeBinding Light=#CC0000, Dark=#FF6666}" FontSize="16" CornerRadius="17" BorderColor="{AppThemeBinding Light=#FFCCCC, Dark=#664444}" BorderWidth="1" Padding="0" VerticalOptions="End" HorizontalOptions="Center" />
                                        <StackLayout Grid.Row="1" Grid.ColumnSpan="4" Orientation="Horizontal" Spacing="15" Margin="0,5,0,0">
                                            <Label Text="{Binding Calories, StringFormat='âš¡ {0:F1} kcal'}" FontSize="11" TextColor="Gray" />
                                            <Label Text="{Binding Protein, StringFormat='ðŸ¥© {0:F1}g'}" FontSize="11" TextColor="Gray" />
                                            <Label Text="{Binding Fat, StringFormat='ðŸ§ˆ {0:F1}g'}" FontSize="11" TextColor="Gray" />
                                            <Label Text="{Binding Carbs, StringFormat='ðŸŒ¾ {0:F1}g'}" FontSize="11" TextColor="Gray" />
                                        </StackLayout>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                    <Button Command="{Binding AddIngredientCommand}" BackgroundColor="{DynamicResource Primary}" HeightRequest="45" Text="{loc:Translate Resource=AddRecipePageResources, Key=AddIngredient}" />
                </StackLayout>
                <!-- Nutrition Tab -->
                <StackLayout IsVisible="{Binding IsNutritionTabSelected}" Spacing="15">
                    <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=NutritionHeader}" FontSize="18" FontAttributes="Bold" Margin="0,0,0,5" />
                    <StackLayout Spacing="10">
                        <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=CalcModeLabel}" FontSize="14" FontAttributes="Bold" />
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                            <Button Grid.Column="0" BackgroundColor="{Binding UseCalculatedValues, Converter={StaticResource BoolToColorConverter}, ConverterParameter=SegmentSelectedBg}" TextColor="{Binding UseCalculatedValues, Converter={StaticResource BoolToColorConverter}, ConverterParameter=SegmentText}" HeightRequest="40" Clicked="OnAutoModeClicked" Text="{loc:Translate Resource=AddRecipePageResources, Key=AutoButton}" />
                            <Button Grid.Column="1" BackgroundColor="{Binding UseManualValues, Converter={StaticResource BoolToColorConverter}, ConverterParameter=SegmentSelectedBg}" TextColor="{Binding UseManualValues, Converter={StaticResource BoolToColorConverter}, ConverterParameter=SegmentText}" HeightRequest="40" Clicked="OnManualModeClicked" Text="{loc:Translate Resource=AddRecipePageResources, Key=ManualButton}" />
                        </Grid>
                    </StackLayout>
                    <StackLayout IsVisible="{Binding UseCalculatedValues}" Spacing="10">
                        <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=AutoCalculatedInfo}" FontSize="12" FontAttributes="Italic" HorizontalTextAlignment="Center" />
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10" RowDefinitions="Auto,Auto" RowSpacing="10">
                            <StackLayout Grid.Row="0" Grid.Column="0" Spacing="5">
                                <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=CaloriesLabel}" FontAttributes="Bold" />
                                <Label Text="{Binding CalculatedCalories}" FontSize="16" HorizontalTextAlignment="Center" BackgroundColor="LightGray" Padding="10" TextColor="Black" />
                            </StackLayout>
                            <StackLayout Grid.Row="0" Grid.Column="1" Spacing="5">
                                <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=ProteinLabel}" FontAttributes="Bold" />
                                <Label Text="{Binding CalculatedProtein}" FontSize="16" HorizontalTextAlignment="Center" BackgroundColor="LightGray" Padding="10" TextColor="Black" />
                            </StackLayout>
                            <StackLayout Grid.Row="1" Grid.Column="0" Spacing="5">
                                <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=FatLabel}" FontAttributes="Bold" />
                                <Label Text="{Binding CalculatedFat}" FontSize="16" HorizontalTextAlignment="Center" BackgroundColor="LightGray" Padding="10" TextColor="Black" />
                            </StackLayout>
                            <StackLayout Grid.Row="1" Grid.Column="1" Spacing="5">
                                <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=CarbsLabel}" FontAttributes="Bold" />
                                <Label Text="{Binding CalculatedCarbs}" FontSize="16" HorizontalTextAlignment="Center" BackgroundColor="LightGray" Padding="10" TextColor="Black" />
                            </StackLayout>
                        </Grid>
                    </StackLayout>
                    <StackLayout IsVisible="{Binding UseManualValues}" Spacing="10">
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                            <Label Grid.Column="0" Text="{loc:Translate Resource=AddRecipePageResources, Key=ManualInputLabel}" FontSize="12" FontAttributes="Italic" VerticalOptions="Center" />
                            <Button Grid.Column="1" Command="{Binding CopyCalculatedValuesCommand}" FontSize="12" HeightRequest="30" BackgroundColor="{DynamicResource Primary}" Text="{loc:Translate Resource=AddRecipePageResources, Key=CopyCalculated}" />
                        </Grid>
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10" RowDefinitions="Auto,Auto" RowSpacing="10">
                            <Frame Grid.Row="0" Grid.Column="0" BorderColor="LightGray" Padding="8" CornerRadius="8">
                                <StackLayout Spacing="5">
                                    <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=CaloriesLabel}" FontAttributes="Bold" FontSize="14" />
                                    <Entry Placeholder="0.0" Keyboard="Numeric" Text="{Binding Calories}" ClearButtonVisibility="WhileEditing" FontSize="16" />
                                </StackLayout>
                            </Frame>
                            <Frame Grid.Row="0" Grid.Column="1" BorderColor="LightGray" Padding="8" CornerRadius="8">
                                <StackLayout Spacing="5">
                                    <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=ProteinLabel}" FontAttributes="Bold" FontSize="14" />
                                    <Entry Placeholder="0.0" Keyboard="Numeric" Text="{Binding Protein}" ClearButtonVisibility="WhileEditing" FontSize="16" />
                                </StackLayout>
                            </Frame>
                            <Frame Grid.Row="1" Grid.Column="0" BorderColor="LightGray" Padding="8" CornerRadius="8">
                                <StackLayout Spacing="5">
                                    <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=FatLabel}" FontAttributes="Bold" FontSize="14" />
                                    <Entry Placeholder="0.0" Keyboard="Numeric" Text="{Binding Fat}" ClearButtonVisibility="WhileEditing" FontSize="16" />
                                </StackLayout>
                            </Frame>
                            <Frame Grid.Row="1" Grid.Column="1" BorderColor="LightGray" Padding="8" CornerRadius="8">
                                <StackLayout Spacing="5">
                                    <Label Text="{loc:Translate Resource=AddRecipePageResources, Key=CarbsLabel}" FontAttributes="Bold" FontSize="14" />
                                    <Entry Placeholder="0.0" Keyboard="Numeric" Text="{Binding Carbs}" ClearButtonVisibility="WhileEditing" FontSize="16" />
                                </StackLayout>
                            </Frame>
                        </Grid>
                    </StackLayout>
                </StackLayout>
                <StackLayout Spacing="10" Margin="0,20,0,0">
                    <Button Command="{Binding SaveRecipeCommand}" Text="{Binding SaveButtonText}" BackgroundColor="{DynamicResource Primary}" HeightRequest="50" FontSize="16" FontAttributes="Bold">
                        <Button.ImageSource>
                            <FileImageSource File="save.png" />
                        </Button.ImageSource>
                    </Button>
                </StackLayout>
                <Label Text="{Binding ValidationMessage}" FontSize="12" IsVisible="{Binding HasValidationError}" HorizontalTextAlignment="Center" TextColor="Red" Margin="0,10,0,0" />
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
